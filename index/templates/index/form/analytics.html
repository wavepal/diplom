{% extends 'index/layout.html' %}
{% load static %}
{% load get_property %}
{% load generate_color %}
{% load count %}
{% load calculate_penalty %}
{% load get_response %}
{% load to_int %}
{% load divide %}
{% load get_item %}
{% block title %}{{form.title}} - Medical Forms{% endblock %}
{% block script %}
<script src="{% static 'index/analytics.js' %}" defer></script>
<script src="{% static 'lib/cookie.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize table zoom functionality
    initializeTableZoom();
    
    // Initialize scroll indicators
    initializeScrollIndicators();
    
    // Инициализация обработчиков прокрутки для таблиц
    initializeTableScrollHandlers();
    
    // Добавляем обработчики для переключателей видимости столбцов и строк
    document.querySelectorAll('.toggle-column').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const column = this.dataset.column;
            const cells = document.querySelectorAll(`.column-${column}`);
            cells.forEach(cell => {
                cell.style.display = this.checked ? '' : 'none';
            });
        });
    });

    document.querySelectorAll('.toggle-med-center').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const medCenter = this.dataset.medCenter;
            const rows = document.querySelectorAll(`.med-center-row[data-med-center="${medCenter}"]`);
            rows.forEach(row => {
                row.style.display = this.checked ? '' : 'none';
            });
        });
    });

    // Функция для загрузки данных аналитики
    function loadAnalyticsData(dataType) {
        const loadingIndicator = document.getElementById(`loading-${dataType}`);
        if (loadingIndicator) loadingIndicator.style.display = 'block';

        // Get the base URL from Django template tag and construct full URL
        const baseUrl = "{% url 'load_analytics_data' code=form.code %}";
        const url = new URL(window.location.origin + baseUrl);
        url.searchParams.append('data_type', dataType);
        
        // Добавляем все параметры фильтрации
        const filterParams = new FormData(document.getElementById('filter-form'));
        for (let [key, value] of filterParams.entries()) {
            url.searchParams.append(key, value);
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                
                // Обновляем соответствующий раздел на странице
                updateSection(dataType, data);
            })
            .catch(error => {
                console.error('Error loading data:', error);
                if (loadingIndicator) {
                    loadingIndicator.textContent = 'Ошибка загрузки данных';
                    loadingIndicator.style.color = 'red';
                }
            });
    }

    // Функция для обновления разделов страницы
    function updateSection(dataType, data) {
        switch(dataType) {
            case 'summary':
                updateSummarySection(data);
                break;
            case 'averages':
                updateAveragesSection(data);
                break;
            case 'med_stats':
                updateMedStatsSection(data);
                break;
            case 'range_slider':
                // Placeholder function to prevent error
                function updateRangeSliderSection(data) {
                    console.log('Range slider data:', data);
                    // Implement range slider update logic here
                }
                updateRangeSliderSection(data);
                break;
            case 'final_scores':
                updateFinalScoresSection(data);
                break;
        }
    }

    // Инициализация наблюдателя за видимостью секций
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const section = entry.target;
                const dataType = section.getAttribute('data-analytics-type');
                if (dataType && !section.hasAttribute('data-loaded')) {
                    loadAnalyticsData(dataType);
                    section.setAttribute('data-loaded', 'true');
                }
            }
        });
    }, {
        root: null,
        rootMargin: '50px',
        threshold: 0.1
    });

    // Наблюдаем за секциями аналитики
    document.querySelectorAll('[data-analytics-type]').forEach(section => {
        observer.observe(section);
    });

    // Обработчик изменения фильтров
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault(); // Предотвращаем стандартную отправку формы
        
        // Получаем данные формы
        const formData = new FormData(this);
        const searchParams = new URLSearchParams(formData);
        
        // Обновляем URL с параметрами фильтрации без перезагрузки страницы
        const newUrl = window.location.pathname + '?' + searchParams.toString();
        window.history.pushState({}, '', newUrl);
        
        // Очищаем таблицы
        document.querySelector('#responsesTable tbody').innerHTML = '';
        document.querySelector('#medCenterTable tbody').innerHTML = '';
        document.querySelector('#totalScoresTable tbody').innerHTML = '';
        
        // Добавляем индикаторы загрузки
        const tables = ['responsesTable', 'medCenterTable', 'totalScoresTable'];
        tables.forEach(tableId => {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const loadingRow = document.createElement('tr');
            loadingRow.className = 'loading-indicator';
            loadingRow.innerHTML = `<td colspan="${document.querySelectorAll(`#${tableId} th`).length}">Загрузка данных...</td>`;
            tbody.appendChild(loadingRow);
        });
        
        // Сбрасываем страницы для всех таблиц
        window.tablePages = {
            responsesTable: 1,
            medCenterTable: 1,
            totalScoresTable: 1
        };
        
        // Загружаем данные для каждой таблицы
        loadTableData('responsesTable', 'responses/load_table');
        loadTableData('medCenterTable', 'responses/load_med_centers');
        loadTableData('totalScoresTable', 'responses/load_total_scores');
    });

    // Initialize table zoom functionality
    initializeTableZoom();
    
    // Initialize scroll indicators
    initializeScrollIndicators();
    
    // Инициализация обработчиков прокрутки для таблиц
    initializeTableScrollHandlers();
});

// Функция для загрузки данных таблицы
function loadTableData(tableId, endpoint, page = 1) {
    const formCode = window.location.pathname.split('/')[2]; // Получаем код формы из URL
    const formData = new FormData(document.getElementById('filter-form'));
    const searchParams = new URLSearchParams(formData);
    searchParams.append('page', page);
    searchParams.append('per_page', 20);
    
    const url = `/form/${formCode}/${endpoint}?${searchParams.toString()}`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const tbody = document.querySelector(`#${tableId} tbody`);
        
        // Удаляем индикатор загрузки
        const loadingIndicator = tbody.querySelector('.loading-indicator');
        if (loadingIndicator) {
            tbody.removeChild(loadingIndicator);
        }
        
        // Добавляем новые строки
        data.rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = row.html;
            tbody.appendChild(tr);
        });
        
        // Сохраняем информацию о наличии следующей страницы
        window.tableHasMore = window.tableHasMore || {};
        window.tableHasMore[tableId] = data.has_next;
        
        // Если есть еще страницы и таблица видима, добавляем индикатор загрузки
        if (data.has_next) {
            const tableContainer = document.querySelector(`#${tableId}-container`);
            if (tableContainer && isElementInViewport(tableContainer)) {
                window.tablePages = window.tablePages || {};
                window.tablePages[tableId] = page + 1;
                loadTableData(tableId, endpoint, page + 1);
            } else {
                // Добавляем индикатор загрузки, который будет виден при прокрутке
                const loadingRow = document.createElement('tr');
                loadingRow.className = 'loading-indicator';
                loadingRow.innerHTML = `<td colspan="${document.querySelectorAll(`#${tableId} th`).length}">Прокрутите для загрузки дополнительных данных</td>`;
                tbody.appendChild(loadingRow);
            }
        }
        
        // После загрузки данных, применяем форматирование для значений
        applyValueFormatting(tableId);
    })
    .catch(error => {
        console.error('Error loading table data:', error);
        const tbody = document.querySelector(`#${tableId} tbody`);
        const loadingIndicator = tbody.querySelector('.loading-indicator');
        if (loadingIndicator) {
            loadingIndicator.innerHTML = `<td colspan="${document.querySelectorAll(`#${tableId} th`).length}">Ошибка загрузки данных: ${error.message}</td>`;
        }
    });
}

// Функция для применения форматирования значений в таблице
function applyValueFormatting(tableId) {
    if (tableId === 'medCenterTable') {
        // Для average-slider-value
        const averageSliderElements = document.querySelectorAll('.average-slider-value');
        const averageSliderPercentageCheckbox = document.querySelector('.average-slider-percentage');
        const isPercentage = averageSliderPercentageCheckbox ? averageSliderPercentageCheckbox.checked : false;
        
        averageSliderElements.forEach(function (element) {
            const value = parseFloat(element.dataset.rawValue);
            if (element.dataset.rawValue === 'N/A') {
                element.textContent = 'N/A';
                element.style.color = '';
                return;
            }
            const maxRangeValue = element.closest('td').dataset.maxValue;
            if (isPercentage) {
                const percentage = (value / maxRangeValue) * 100;
                element.textContent = percentage.toFixed(2) + '%';
                element.style.color = getColorBasedOnPercentage(percentage);
            } else {
                element.textContent = value;
                element.style.color = '';
            }
        });
    } else if (tableId === 'responsesTable') {
        // Для range-slider-value
        const rangeSliderElements = document.querySelectorAll('.range-slider-value');
        const rangeSliderPercentageCheckbox = document.querySelector('.range-slider-percentage');
        const isPercentage = rangeSliderPercentageCheckbox ? rangeSliderPercentageCheckbox.checked : false;
        
        rangeSliderElements.forEach(function (element) {
            const value = parseFloat(element.dataset.rawValue);
            const maxRangeValue = element.closest('td').dataset.maxValue;
            element.dataset.rawValue = value;
            if (!isNaN(value) && value !== null) {
                if (isPercentage) {
                    const percentage = (value / maxRangeValue) * 100;
                    element.textContent = percentage.toFixed(2) + '%';
                    element.style.color = getColorBasedOnPercentage(percentage);
                } else {
                    element.textContent = value;
                    element.style.color = '';
                }
            } else {
                element.textContent = 'N/A';
                element.style.color = '';
            }
        });
    }
}

// Функция для определения цвета на основе процента
function getColorBasedOnPercentage(percentage) {
    if (percentage >= 80) {
        return '#00a000'; // Темно-зеленый
    } else if (percentage >= 50) {
        return '#ffd700'; // Золотисто-желтый
    } else {
        return '#ff4500'; // Красно-оранжевый
    }
}

// Вспомогательная функция для проверки видимости элемента
function isElementInViewport(el) {
    const rect = el.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// Функция для инициализации обработчиков прокрутки таблиц
function initializeTableScrollHandlers() {
    const tableContainers = [
        document.getElementById('responsesTable-container'),
        document.getElementById('medCenterTable-container'),
        document.getElementById('totalScoresTable-container')
    ];
    
    const endpoints = {
        'responsesTable': 'responses/load_table',
        'medCenterTable': 'responses/load_med_centers',
        'totalScoresTable': 'responses/load_total_scores'
    };
    
    tableContainers.forEach(container => {
        if (!container) return;
        
        container.addEventListener('scroll', function() {
            const tableId = this.id.replace('-container', '');
            
            // Проверяем, достигли ли мы конца таблицы
            if (this.scrollHeight - this.scrollTop <= this.clientHeight + 100) {
                // Проверяем, есть ли еще страницы для загрузки
                if (window.tableHasMore && window.tableHasMore[tableId]) {
                    // Проверяем, не загружаются ли уже данные
                    const loadingIndicator = this.querySelector('.loading-indicator');
                    if (!loadingIndicator || loadingIndicator.style.display === 'none') {
                        // Загружаем следующую страницу
                        window.tablePages = window.tablePages || {};
                        window.tablePages[tableId] = window.tablePages[tableId] || 2;
                        
                        loadTableData(tableId, endpoints[tableId], window.tablePages[tableId]);
                    }
                }
            }
        });
    });
}

// Функция для обновления всех таблиц
function refreshAllTables() {
    // Очищаем таблицы
    document.querySelector('#responsesTable tbody').innerHTML = '';
    document.querySelector('#medCenterTable tbody').innerHTML = '';
    document.querySelector('#totalScoresTable tbody').innerHTML = '';
    
    // Добавляем индикаторы загрузки
    const tables = ['responsesTable', 'medCenterTable', 'totalScoresTable'];
    tables.forEach(tableId => {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const loadingRow = document.createElement('tr');
        loadingRow.className = 'loading-indicator';
        loadingRow.innerHTML = `<td colspan="${document.querySelectorAll(`#${tableId} th`).length}">Загрузка данных...</td>`;
        tbody.appendChild(loadingRow);
    });
    
    // Сбрасываем страницы для всех таблиц
    window.tablePages = {
        responsesTable: 1,
        medCenterTable: 1,
        totalScoresTable: 1
    };
    
    // Загружаем данные для каждой таблицы
    loadTableData('responsesTable', 'responses/load_table');
    loadTableData('medCenterTable', 'responses/load_med_centers');
    loadTableData('totalScoresTable', 'responses/load_total_scores');
}

// Функция для инициализации табличного масштаба
function initializeTableZoom() {
    // Get all zoom buttons
    const zoomInButtons = document.querySelectorAll('.zoom-in');
    const zoomOutButtons = document.querySelectorAll('.zoom-out');
    
    // Set initial zoom levels
    const zoomLevels = {
        'responsesTable': 100,
        'medCenterTable': 100,
        'totalScoresTable': 100
    };
    
    // Set initial zoom class
    document.querySelectorAll('.responses-table').forEach(table => {
        table.classList.add('zoom-100');
    });
    
    // Add event listeners for zoom in buttons
    zoomInButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tableId = this.getAttribute('data-table');
            const tableContainer = document.getElementById(tableId + '-container');
            const zoomLevelDisplay = document.getElementById(tableId + '-zoom');
            
            // Increase zoom level (max 150%)
            if (zoomLevels[tableId] < 150) {
                // Remove current zoom class
                tableContainer.classList.remove(`zoom-${zoomLevels[tableId]}`);
                
                // Increase zoom level
                zoomLevels[tableId] += 15;
                if (zoomLevels[tableId] > 150) zoomLevels[tableId] = 150;
                
                // Update zoom
                updateTableZoom(tableContainer, zoomLevelDisplay, zoomLevels[tableId]);
            }
        });
    });
    
    // Add event listeners for zoom out buttons
    zoomOutButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tableId = this.getAttribute('data-table');
            const tableContainer = document.getElementById(tableId + '-container');
            const zoomLevelDisplay = document.getElementById(tableId + '-zoom');
            
            // Decrease zoom level (min 70%)
            if (zoomLevels[tableId] > 75) {
                // Remove current zoom class
                tableContainer.classList.remove(`zoom-${zoomLevels[tableId]}`);
                
                // Decrease zoom level
                zoomLevels[tableId] -= 15;
                if (zoomLevels[tableId] < 75) zoomLevels[tableId] = 75;
                
                // Update zoom
                updateTableZoom(tableContainer, zoomLevelDisplay, zoomLevels[tableId]);
            }
        });
    });
}

function updateTableZoom(tableContainer, zoomLevelDisplay, zoomLevel) {
    // Update the zoom class
    tableContainer.classList.add(`zoom-${zoomLevel}`);
    
    // Update the zoom level display
    zoomLevelDisplay.textContent = zoomLevel + '%';
}

// Функция для инициализации прокрутки таблиц
function initializeScrollIndicators() {
    const tableContainers = document.querySelectorAll('.responses-table');
    
    tableContainers.forEach(container => {
        const indicator = container.querySelector('.table-scroll-indicator');
        
        // Check if horizontal scrolling is needed
        function checkScroll() {
            if (container.scrollWidth > container.clientWidth) {
                indicator.style.opacity = '1';
                
                // Hide indicator after 3 seconds
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 3000);
            } else {
                indicator.style.opacity = '0';
            }
        }
        
        // Check on load and resize
        checkScroll();
        window.addEventListener('resize', checkScroll);
        
        // Hide indicator when scrolling
        container.addEventListener('scroll', () => {
            indicator.style.opacity = '0';
        });
    });
}

// Функция для инициализации таблиц
function initializeTables() {
    // Очищаем таблицы
    document.querySelector('#responsesTable tbody').innerHTML = '';
    document.querySelector('#medCenterTable tbody').innerHTML = '';
    document.querySelector('#totalScoresTable tbody').innerHTML = '';
    
    // Добавляем индикаторы загрузки
    const tables = ['responsesTable', 'medCenterTable', 'totalScoresTable'];
    tables.forEach(tableId => {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const loadingRow = document.createElement('tr');
        loadingRow.className = 'loading-indicator';
        loadingRow.innerHTML = `<td colspan="${document.querySelectorAll(`#${tableId} th`).length}">Загрузка данных...</td>`;
        tbody.appendChild(loadingRow);
    });
    
    // Сбрасываем страницы для всех таблиц
    window.tablePages = {
        responsesTable: 1,
        medCenterTable: 1,
        totalScoresTable: 1
    };
    
    // Загружаем данные для каждой таблицы
    loadTableData('responsesTable', 'responses/load_table');
    loadTableData('medCenterTable', 'responses/load_med_centers');
    loadTableData('totalScoresTable', 'responses/load_total_scores');
}

function updateExportForm() {
    // Получаем все данные формы фильтрации
    const formData = new FormData(document.getElementById('filter-form'));
    const formParams = new URLSearchParams(formData);
    
    // Получаем информацию о скрытых столбцах
    let hidden_columns = [];
    document.querySelectorAll('.toggle-column').forEach(checkbox => {
        if (!checkbox.checked) {
            hidden_columns.push(checkbox.dataset.column);
        }
    });

    // Получаем настройки сортировки из таблицы
    const sortColumn = document.querySelector('.sort-active')?.dataset?.column || '';
    const sortDirection = document.querySelector('.sort-active')?.classList.contains('sort-desc') ? 'desc' : 'asc';

    // Получаем настройки отображения процентов
    const rangeSliderPercentageCheckbox = document.querySelector('.range-slider-percentage');
    const totalScorePercentageCheckbox = document.querySelector('.total-score-percentage');

    const export_as_percentage = rangeSliderPercentageCheckbox ? rangeSliderPercentageCheckbox.checked : false;
    const export_total_as_percentage = totalScorePercentageCheckbox ? totalScorePercentageCheckbox.checked : false;

    // Добавляем все параметры в URL
    formParams.set('export_hidden_columns', hidden_columns.join(','));
    formParams.set('export_as_percentage', export_as_percentage);
    formParams.set('export_total_as_percentage', export_total_as_percentage);
    formParams.set('sort_column', sortColumn);
    formParams.set('sort_direction', sortDirection);
    
    // Добавляем выбранные фильтры ответов
    document.querySelectorAll('.question-filter').forEach(filter => {
        const questionId = filter.dataset.questionId;
        const selectedOptions = Array.from(filter.selectedOptions).map(option => option.value);
        if (selectedOptions.length > 0) {
            selectedOptions.forEach(value => {
                formParams.append(`question-${questionId}`, value);
            });
        }
    });
    
    // Создаем URL для экспорта
    const formCode = window.location.pathname.split('/')[2];
    const exportUrl = `/form/${formCode}/responses/export_excel/?${formParams.toString()}`;
    
    // Перенаправляем на URL экспорта
    window.location.href = exportUrl;
}

function updateExportCombinedForm() {
    // Получаем все данные формы фильтрации
    const formData = new FormData(document.getElementById('filter-form'));
    const formParams = new URLSearchParams(formData);
    
    // Получаем информацию о видимых столбцах
    const visibleColumns = [];
    document.querySelectorAll('.toggle-column').forEach(checkbox => {
        if (checkbox.checked) {
            visibleColumns.push(checkbox.dataset.column);
        }
    });

    // Получаем информацию о видимых медцентрах
    const visibleMedCenters = [];
    document.querySelectorAll('.toggle-med-center').forEach(checkbox => {
        if (checkbox.checked) {
            visibleMedCenters.push(checkbox.dataset.medCenter);
        }
    });

    // Получаем информацию о процентах
    const averageSliderPercentageCheckbox = document.querySelector('.average-slider-percentage');
    const export_as_percentage = averageSliderPercentageCheckbox ? averageSliderPercentageCheckbox.checked : false;

    // Получаем информацию о скрытии общего количества ответов
    const hideTotalResponsesCheckbox = document.querySelector('.toggle-column[data-column="total-responses"]');
    const hide_total_responses = hideTotalResponsesCheckbox ? !hideTotalResponsesCheckbox.checked : false;
    
    // Добавляем параметры в URL
    formParams.set('visible_columns', visibleColumns.join(','));
    formParams.set('visible_med_centers', visibleMedCenters.join(','));
    formParams.set('export_as_percentage', export_as_percentage);
    formParams.set('hide_total_responses', hide_total_responses);
    
    // Создаем URL для экспорта
    const formCode = window.location.pathname.split('/')[2];
    const exportUrl = `/form/${formCode}/responses/export_combined/?${formParams.toString()}`;
    
    // Перенаправляем на URL экспорта
    window.location.href = exportUrl;
}

function exportFinalScores() {
    // Получаем все данные формы фильтрации
    const formData = new FormData(document.getElementById('filter-form'));
    const formParams = new URLSearchParams(formData);
    
    // Создаем URL для экспорта
    const formCode = window.location.pathname.split('/')[2];
    const exportUrl = `/form/${formCode}/responses/export_final_scores/?${formParams.toString()}`;
    
    // Перенаправляем на URL экспорта
    window.location.href = exportUrl;
}
</script>
{% endblock %}
{% block body %}
<div class="container-fluid">
    {% with active_tab='responses' %}
        {% include 'index/includes/sidebar.html' %}
    {% endwith %}
    <div class="container main-body">
        <span id="bg-color" style="display: none;">{{form.background_color}}</span>
        <span id="text-color" style="display: none;">{{form.text_color}}</span>
        <div class="margin-top-bottom box question-box table-settings" id="responses">
            {% if responses.count > 0 %}
            <h1 class="response-title">Список ответов:</h1>
            <input type="text" id="response-search" class="search-bar" placeholder="Поиск">
            <form id="response-form">
                {% csrf_token %}
                <ul class="modal-content" style="margin: 10px; padding: 0 25px; max-height: 40vh; overflow-y: auto; overflow-x: hidden;">
                    <!-- Responses will be loaded dynamically via JavaScript -->
                </ul>
                {% if request.user.is_superuser %}
                <button type="button" class="btn btn-danger" id="delete-selected-responses">Удалить выделенные ответы</button>
                <button type="button" class="btn btn-danger" id="delete-responses">Очистить ответы</button>
                {% endif %}
            </form>
            {% else %}
            <h1 class="response-title">0 ответов</h1>
            {% endif %}
        </div>
        <div class="margin-top-bottom box question-box table-settings">
            <h1 class="response-title">Фильтрация данных</h1>
            
            <div class="filter-container">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-tab="location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Локация</span>
                    </button>
                    <button class="filter-tab" data-tab="demographics">
                        <i class="fas fa-users"></i>
                        <span>Демография</span>
                    </button>
                    <button class="filter-tab" data-tab="answers">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Ответы</span>
                    </button>
                    <button class="filter-tab" data-tab="dates">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Даты</span>
                    </button>
                </div>
                
            <form id="filter-form" method="GET">
                    <div class="filter-content active" id="location-tab">
                        <div class="filter-grid compact-grid">
                            <div class="filter-card compact-card">
                                <div class="filter-card-header">
                                    <i class="fas fa-user-circle"></i>
                                    <h3>Регион пользователя</h3>
                                </div>
                                <div class="filter-card-body">
                                    <div class="filter-field">
                    <select class="filter-select" id="cities" name="cities">
                        <option value="">Все регионы</option>
                        {% for city_code, city_name in city_choices %}
                            <option value="{{ city_code }}" {% if request.GET.cities == city_code %}selected{% endif %}>
                                {{ city_name }}
                            </option>
                        {% endfor %}
                    </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-card compact-card">
                                <div class="filter-card-header">
                                    <i class="fas fa-hospital"></i>
                                    <h3>Регион медцентра</h3>
                                </div>
                                <div class="filter-card-body">
                                    <div class="filter-field">
                    <select class="filter-select" id="med_region" name="med_region">
                        <option value="">Все регионы</option>
                        {% for city_code, city_name in city_choices %}
                            <option value="{{ city_code }}" {% if request.GET.med_region == city_code %}selected{% endif %}>
                                {{ city_name }}
                            </option>
                        {% endfor %}
                    </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-card compact-card">
                                <div class="filter-card-header">
                                    <i class="fas fa-layer-group"></i>
                                    <h3>Группа медцентров</h3>
                                </div>
                                <div class="filter-card-body">
                                    <div class="filter-field">
                    <select class="filter-select" id="med_group" name="med_group">
                        <option value="">Все группы</option>
                        {% for group in med_center_groups %}
                            <option value="{{ group.id }}" {% if request.GET.med_group == group.id|stringformat:"s" %}selected{% endif %}>
                                {{ group.name }}
                            </option>
                        {% endfor %}
                    </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-card compact-card">
                                <div class="filter-card-header">
                                    <i class="fas fa-clinic-medical"></i>
                                    <h3>Медцентр</h3>
                                </div>
                                <div class="filter-card-body">
                                    <div class="filter-field">
                    <select class="filter-select" id="med_center" name="med_center">
                        <option value="">Все медцентры</option>
                        {% for med_center in med_centers %}
                            <option value="{{ med_center }}" {% if request.GET.med_center == med_center %}selected{% endif %}>
                                {{ med_center }}
                            </option>
                        {% endfor %}
                    </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-content" id="demographics-tab">
                        <div class="filter-grid compact-grid">
                            <div class="filter-card compact-card">
                                <div class="filter-card-header">
                                    <i class="fas fa-venus-mars"></i>
                                    <h3>Пол</h3>
                                </div>
                                <div class="filter-card-body">
                                    <div class="filter-field">
                                        <div class="gender-options">
                                            <label class="gender-option">
                                                <input type="radio" name="gender" value="" {% if not request.GET.gender %}checked{% endif %}>
                                                <span class="gender-icon"><i class="fas fa-users"></i></span>
                                                <span>Все</span>
                                            </label>
                                            <label class="gender-option">
                                                <input type="radio" name="gender" value="M" {% if request.GET.gender == 'M' %}checked{% endif %}>
                                                <span class="gender-icon"><i class="fas fa-male"></i></span>
                                                <span>Мужской</span>
                                            </label>
                                            <label class="gender-option">
                                                <input type="radio" name="gender" value="F" {% if request.GET.gender == 'F' %}checked{% endif %}>
                                                <span class="gender-icon"><i class="fas fa-female"></i></span>
                                                <span>Женский</span>
                                            </label>
                                            <!-- <label class="gender-option">
                                                <input type="radio" name="gender" value="O" {% if request.GET.gender == 'O' %}checked{% endif %}>
                                                <span class="gender-icon"><i class="fas fa-transgender"></i></span>
                                                <span>Другой</span>
                                            </label> -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-card compact-card">
                                <div class="filter-card-header">
                                    <i class="fas fa-birthday-cake"></i>
                                    <h3>Возраст</h3>
                                </div>
                                <div class="filter-card-body">
                                    <div class="filter-field age-range">
                                        <div class="age-slider-container">
                                            <div class="age-inputs">
                                                <div class="age-input-group">
                                                    <label for="age_min">От</label>
                                                    <input type="number" id="age_min" name="age_min" min="0" max="100" value="{{ request.GET.age_min }}" class="age-input">
                                                </div>
                                                <div class="age-input-group">
                                                    <label for="age_max">До</label>
                                                    <input type="number" id="age_max" name="age_max" min="0" max="100" value="{{ request.GET.age_max }}" class="age-input">
                                                </div>
                                            </div>
                                            <div class="age-presets">
                                                <button type="button" class="age-preset" data-min="18" data-max="30">18-30</button>
                                                <button type="button" class="age-preset" data-min="31" data-max="45">31-45</button>
                                                <button type="button" class="age-preset" data-min="46" data-max="60">46-60</button>
                                                <button type="button" class="age-preset" data-min="61" data-max="100">61+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-content" id="answers-tab">
                        <div class="filter-grid compact-grid answers-grid">
                {% for question in form.questions.all %}
                    {% if question.question_type == "multiple choice" or question.question_type == "checkbox" %}
                                    <div class="filter-card compact-card">
                                        <div class="filter-card-header">
                                            <i class="fas fa-question-circle"></i>
                                            <h3>{{ question.question }}</h3>
                                        </div>
                                        <div class="filter-card-body">
                                            <div class="filter-field">
                                                <select class="filter-select choices-select" id="question-{{ question.id }}" name="question-{{ question.id }}" multiple>
                                <option value="">Все</option>
                                {% for choice in question.choices.all %}
                                    <option value="{{ choice.id }}" 
                                        {% if choice.id|stringformat:"s" in request.GET.getlist|add:"question-"|add:question.id|stringformat:"s" %}
                                            selected
                                        {% endif %}>
                                        {{ choice.choice }}
                                    </option>
                                {% endfor %}
                            </select>
                                            </div>
                                        </div>
                                    </div>
                    {% endif %}
                {% endfor %}
                        </div>
                    </div>
                    
                    <div class="filter-content" id="dates-tab">
                        <div class="filter-grid compact-grid">
                            <div class="filter-card compact-card date-filter-card">
                                <div class="filter-card-header">
                                    <i class="fas fa-calendar-day"></i>
                                    <h3>Период</h3>
                                </div>
                                <div class="filter-card-body">
                                    <div class="date-range-container">
                                        <div class="date-field">
                                            <label for="date_from">Начало периода</label>
                                            <div class="date-input-wrapper">
                    <input type="date" id="date_from" name="date_from" 
                           value="{{ request.GET.date_from }}" 
                           class="filter-date">
                                            </div>
                                        </div>
                                        <div class="date-field">
                                            <label for="date_to">Конец периода</label>
                                            <div class="date-input-wrapper">
                    <input type="date" id="date_to" name="date_to" 
                           value="{{ request.GET.date_to }}"
                           class="filter-date">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="date-presets">
                                        <button type="button" class="date-preset" data-days="7">Последние 7 дней</button>
                                        <button type="button" class="date-preset" data-days="30">Последние 30 дней</button>
                                        <button type="button" class="date-preset" data-days="90">Последние 3 месяца</button>
                                        <button type="button" class="date-preset" data-days="365">Последний год</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button type="submit" class="filter-apply-btn">
                            <i class="fas fa-filter"></i>
                            <span>Применить фильтры</span>
                        </button>
                        <button type="button" id="reset-filters" class="filter-reset-btn">
                            <i class="fas fa-times"></i>
                            <span>Сбросить все</span>
                        </button>
                </div>
            </form>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Tab switching
                const tabs = document.querySelectorAll('.filter-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        // Remove active class from all tabs
                        tabs.forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        // Hide all content sections
                        document.querySelectorAll('.filter-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        // Show the selected content section
                        const tabId = this.getAttribute('data-tab');
                        document.getElementById(tabId + '-tab').classList.add('active');
                    });
                });
                
                // Age presets
                document.querySelectorAll('.age-preset').forEach(preset => {
                    preset.addEventListener('click', function() {
                        const min = this.getAttribute('data-min');
                        const max = this.getAttribute('data-max');
                        
                        document.getElementById('age_min').value = min;
                        document.getElementById('age_max').value = max;
                        
                        // Highlight active preset
                        document.querySelectorAll('.age-preset').forEach(p => p.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // Date presets
                document.querySelectorAll('.date-preset').forEach(preset => {
                    preset.addEventListener('click', function() {
                        const days = parseInt(this.getAttribute('data-days'));
                        
                        // Calculate end date (today)
                        const endDate = new Date();
                        
                        // Calculate start date
                        const startDate = new Date();
                        startDate.setDate(startDate.getDate() - days);
                        
                        // Format dates for input fields
                        document.getElementById('date_from').value = formatDate(startDate);
                        document.getElementById('date_to').value = formatDate(endDate);
                        
                        // Highlight active preset
                        document.querySelectorAll('.date-preset').forEach(p => p.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // Format date as YYYY-MM-DD
                function formatDate(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // Reset filters
                document.getElementById('reset-filters').addEventListener('click', function() {
                // Reset all form fields
                document.getElementById('filter-form').reset();
                
                // Reset all select elements
                document.querySelectorAll('select').forEach(select => {
                    select.value = '';
                });
                    
                    // Reset date fields
                document.getElementById('date_from').value = '';
                document.getElementById('date_to').value = '';
                
                // Reset age fields
                document.getElementById('age_min').value = '';
                document.getElementById('age_max').value = '';
                
                // Remove active classes from presets
                document.querySelectorAll('.age-preset, .date-preset').forEach(preset => {
                    preset.classList.remove('active');
                });
                    
                // Submit the form to update results
                document.getElementById('filter-form').submit();
            });

            // Date validation
            document.getElementById('date_to').addEventListener('change', function() {
                const dateFrom = document.getElementById('date_from').value;
                const dateTo = this.value;
                
                if (dateFrom && dateTo) {
                    const dateFromObj = new Date(dateFrom);
                    const dateToObj = new Date(dateTo);
                    
                    if (dateFromObj > dateToObj) {
                        alert('Дата окончания периода не может быть раньше даты начала');
                        this.value = dateFrom;
                    }
                }
            });

            document.getElementById('date_from').addEventListener('change', function() {
                const dateFrom = this.value;
                const dateTo = document.getElementById('date_to').value;
                
                if (dateFrom && dateTo) {
                    const dateFromObj = new Date(dateFrom);
                    const dateToObj = new Date(dateTo);
                    
                    if (dateFromObj > dateToObj) {
                        alert('Дата начала периода не может быть позже даты окончания');
                        this.value = dateTo;
                    }
                }
            });
            });
        </script>
        <div class="margin-top-bottom box question-box">
            <h1 class="response-title">Таблица данных:</h1>
            <div class="responses-table-controls">
                <div class="table-zoom-controls">
                    <button type="button" class="table-zoom-btn zoom-out" data-table="responsesTable">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span class="table-zoom-level" id="responsesTable-zoom">100%</span>
                    <button type="button" class="table-zoom-btn zoom-in" data-table="responsesTable">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            <div class="responses-table" id="responsesTable-container">
                <div class="table-scroll-indicator">Прокрутите для просмотра</div>
                <table id="responsesTable">
                    <thead>
                        <tr>
                            <th class="column-user">Пользователь</th>
                            <th class="column-city">Город/Область</th>
                            <th class="column-age">Возраст</th>
                            <th class="column-gender">Пол</th>
                            <th class="column-med">Медцентр</th>
                            <th class="column-created-at">Дата проверки</th>
                            {% for summary in responsesSummary %}
                                {% if summary.question.question_type != "title" %}
                                    <th class="column-question-{{ summary.question.id }}">{{ summary.question.question }}
                                    </th>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
            <h2 class="response-title">Настройки таблицы:</h2>
            <form id="columnSelectorForm" class="table-settings">
                <fieldset class="table-field collapsed">
                    <legend>Данные пользователя</legend>
                    <div class="field-content">
                        <label><input type="checkbox" class="toggle-column" data-column="user" checked> Пользователь</label>
                        <label><input type="checkbox" class="toggle-column" data-column="city" checked> Город</label>
                        <label><input type="checkbox" class="toggle-column" data-column="age" checked> Возраст</label>
                        <label><input type="checkbox" class="toggle-column" data-column="gender" checked> Пол</label>
                        <label><input type="checkbox" class="toggle-column" data-column="created-at" checked> Дата проверки</label>
                        <label><input type="checkbox" class="toggle-column" data-column="med" checked> Медцентр</label>
                    </div>
                </fieldset>
                <fieldset class="table-field collapsed">
                    <legend>Вопросы</legend>
                    <div class="field-content">
                        {% for summary in responsesSummary %}
                            {% if summary.question.question_type != "title" %}
                                <label><input type="checkbox" class="toggle-column" data-column="question-{{ summary.question.id }}" checked> {{ summary.question.question }}</label>
                            {% endif %}
                        {% endfor %}
                        <label><p><input type="checkbox" class="range-slider-percentage"> Процентное соотношение</p></label>
                    </div>
                </fieldset>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Добавляем класс collapsed ко всем секциям по умолчанию
                    const fields = document.querySelectorAll('.table-field');
                    fields.forEach(field => {
                        field.classList.add('collapsed');
                    });

                    // Обработчики для сворачивания разделов
                    const legends = document.querySelectorAll('.table-field legend');
                    legends.forEach(legend => {
                        legend.addEventListener('click', function() {
                            const fieldset = this.closest('.table-field');
                            fieldset.classList.toggle('collapsed');
                        });
                    });
                });
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Обработчик изменения отображения процентов для range slider
                    document.querySelector('.range-slider-percentage').addEventListener('change', function () {
                        const isPercentage = this.checked;
                        const rangeSliderElements = document.querySelectorAll('.range-slider-value');

                        rangeSliderElements.forEach(function (element) {
                            let value = parseFloat(element.dataset.rawValue);
                            const maxRangeValue = element.closest('td').dataset.maxValue; // Fetching max value from data attribute
                            if (!isNaN(value) && value !== null) {
                                if (isPercentage) {
                                    const percentage = (value / maxRangeValue) * 100;
                                    element.textContent = percentage.toFixed(2) + '%';
                                    element.style.color = getColorBasedOnPercentage(percentage);
                                } else {
                                    element.textContent = value;
                                    element.style.color = '';
                                }
                            } else {
                                element.textContent = 'N/A';
                                element.style.color = '';
                            }
                        });
                    });
                    
                    // Обработчик изменения отображения процентов для average slider
                    document.querySelector('.average-slider-percentage').addEventListener('change', function () {
                        const isPercentage = this.checked;
                        const averageSliderElements = document.querySelectorAll('.average-slider-value');

                        averageSliderElements.forEach(function (element) {
                            let value = parseFloat(element.dataset.rawValue);
                            if (element.dataset.rawValue === 'N/A') {
                                element.textContent = 'N/A';
                                element.style.color = '';
                                return;
                            }
                            const maxRangeValue = element.closest('td').dataset.maxValue; // Fetching max value from data attribute
                            if (isPercentage) {
                                const percentage = (value / maxRangeValue) * 100;
                                element.textContent = percentage.toFixed(2) + '%';
                                element.style.color = getColorBasedOnPercentage(percentage);
                            } else {
                                element.textContent = value;
                                element.style.color = '';
                            }
                        });
                    });
                    
                    // Обработчики для переключения видимости столбцов
                    document.querySelectorAll('.toggle-column').forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            const column = this.dataset.column;
                            const cells = document.querySelectorAll(`.column-${column}`);
                            cells.forEach(cell => {
                                cell.style.display = this.checked ? '' : 'none';
                            });
                        });
                    });

                    // Обработчики для переключения видимости строк медцентров
                    document.querySelectorAll('.toggle-med-center').forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            const medCenter = this.dataset.medCenter;
                            const rows = document.querySelectorAll(`.med-center-row[data-med-center="${medCenter}"]`);
                            rows.forEach(row => {
                                row.style.display = this.checked ? '' : 'none';
                            });
                        });
                    });
                });
            </script>
            <h1 class="response-title">Экспорт данных</h1>
            <script>
                function updateExportForm() {
                    // Получаем все данные формы фильтрации
                    const formData = new FormData(document.getElementById('filter-form'));
                    const formParams = new URLSearchParams(formData);
                    
                    // Получаем информацию о скрытых столбцах
                    let hidden_columns = [];
                    document.querySelectorAll('.toggle-column').forEach(checkbox => {
                        if (!checkbox.checked) {
                            hidden_columns.push(checkbox.dataset.column);
                        }
                    });
            
                    // Получаем настройки сортировки из таблицы
                    const sortColumn = document.querySelector('.sort-active')?.dataset?.column || '';
                    const sortDirection = document.querySelector('.sort-active')?.classList.contains('sort-desc') ? 'desc' : 'asc';
            
                    // Получаем настройки отображения процентов
                    const rangeSliderPercentageCheckbox = document.querySelector('.range-slider-percentage');
                    const totalScorePercentageCheckbox = document.querySelector('.total-score-percentage');
            
                    const export_as_percentage = rangeSliderPercentageCheckbox ? rangeSliderPercentageCheckbox.checked : false;
                    const export_total_as_percentage = totalScorePercentageCheckbox ? totalScorePercentageCheckbox.checked : false;
            
                    // Добавляем все параметры в URL
                    formParams.set('export_hidden_columns', hidden_columns.join(','));
                    formParams.set('export_as_percentage', export_as_percentage);
                    formParams.set('export_total_as_percentage', export_total_as_percentage);
                    formParams.set('sort_column', sortColumn);
                    formParams.set('sort_direction', sortDirection);
                    
                    // Добавляем выбранные фильтры ответов
                    document.querySelectorAll('.question-filter').forEach(filter => {
                        const questionId = filter.dataset.questionId;
                        const selectedOptions = Array.from(filter.selectedOptions).map(option => option.value);
                        if (selectedOptions.length > 0) {
                            selectedOptions.forEach(value => {
                                formParams.append(`question-${questionId}`, value);
                            });
                        }
                    });
                    
                    // Создаем URL для экспорта
                    const formCode = window.location.pathname.split('/')[2];
                    const exportUrl = `/form/${formCode}/responses/export_excel/?${formParams.toString()}`;
                    
                    // Перенаправляем на URL экспорта
                    window.location.href = exportUrl;
                }
            </script>          
            <form id="export-form" action="javascript:void(0);" method="GET">
                <button type="button" class="btn send-form-btn big-screen" onclick="updateExportForm()">Скачать Excel</button>
            </form>
        </div>
        <div class="margin-top-bottom box question-box">
            <h2 class="response-title">Средние оценки и количество ответов по медцентрам</h2>
            <div class="responses-table-controls">
                <div class="table-zoom-controls">
                    <button type="button" class="table-zoom-btn zoom-out" data-table="medCenterTable">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span class="table-zoom-level" id="medCenterTable-zoom">100%</span>
                    <button type="button" class="table-zoom-btn zoom-in" data-table="medCenterTable">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            <div class="responses-table" id="medCenterTable-container">
                <div class="table-scroll-indicator">Прокрутите для просмотра</div>
                <table id="medCenterTable">
                    <thead>
                        <tr>
                            <th>Медицинский центр</th>
                            {% for question in form.questions.all %}
                                {% if question.question_type == "range slider" %}
                                    <th class="question-header column-{{ question.id }}">{{ question.question }} <span class="column-max-value">(макс. {{ question.max_value }})</span></th>
                                {% endif %}
                            {% endfor %}
                            {% for question in form.questions.all %}
                                {% if question.is_negative %}
                                    <th class="column-answ-{{ question.id }}">{{ question.question }}</th>
                                {% endif %}
                            {% endfor %}
                            <th class="column-main-value">Общая оценка</th>
                            <th class="column-total-responses">Общее количество ответов</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be loaded dynamically -->
                    </tbody>                
                </table>
            </div>
            <h2 class="response-title">Настройки таблицы:</h2>
            <form id="columnSelectorForm" class="table-settings">
                <fieldset class="table-field collapsed">
                    <legend>Значения</legend>
                    <div class="field-content">
                        <label><input type="checkbox" class="toggle-column" data-column="max-value" checked> Максимальные значения</label>
                        <label><input type="checkbox" class="toggle-column" data-column="main-value" checked> Общая оценка</label>
                        <label><input type="checkbox" class="toggle-column" data-column="total-responses" checked> Общее количество ответов</label>
                    </div>
                </fieldset>
                <fieldset class="table-field collapsed">
                    <legend>Медцентры</legend>
                    <div class="field-content">
                        {% for med_center in med_centers %}
                            <label>
                                <input type="checkbox" class="toggle-med-center" data-med-center="{{ med_center }}" checked> {{ med_center }}
                            </label>
                        {% endfor %}
                    </div>
                </fieldset>
                <fieldset class="table-field collapsed">
                    <legend>Критерии</legend>
                    <div class="field-content">
                        {% for question in form.questions.all %}
                            {% if question.question_type == "range slider" %}
                                <label>
                                    <input type="checkbox" class="toggle-column" data-column="{{ question.id }}" checked> {{ question.question }}
                                </label>
                            {% endif %}
                        {% endfor %}
                        <label><p><input type="checkbox" class="average-slider-percentage" checked> Процентное соотношение</p></label>
                    </div>
                </fieldset>
                <fieldset class="table-field collapsed">
                    <legend>Вопросы</legend>
                    <div class="field-content">
                        {% for question in form.questions.all %}
                            {% if question.is_negative %}
                                <label>
                                    <input type="checkbox" class="toggle-column" data-column="answ-{{ question.id }}" checked> {{ question.question }}
                                </label>
                            {% endif %}
                        {% endfor %}
                    </div>
                </fieldset>
            </form>
            <h2 class="response-title">Экспорт данных</h2>
            <form id="export-combined-form" action="javascript:void(0);" method="GET">
                <input type="hidden" name="visible_columns" id="combined_visible_columns">
                <input type="hidden" name="visible_med_centers" id="combined_visible_med_centers">
                <input type="hidden" name="export_as_percentage" id="export-combined-as-percentage">
                <input type="hidden" name="hide_total_responses" id="hide-total-responses">
                <button type="submit" class="btn send-form-btn big-screen" onclick="updateExportCombinedForm()">Скачать Excel</button>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Apply initial column visibility based on checkboxes
                    document.querySelectorAll('.toggle-column').forEach(function(checkbox) {
                        const column = checkbox.dataset.column;
                        const cells = document.querySelectorAll(`.column-${column}`);
                        cells.forEach(cell => {
                            cell.style.display = checkbox.checked ? '' : 'none';
                        });
                    });

                    // Add event listeners for checkbox changes
                    document.querySelectorAll('.toggle-column').forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            const column = this.dataset.column;
                            const cells = document.querySelectorAll(`.column-${column}`);
                            cells.forEach(cell => {
                                cell.style.display = this.checked ? '' : 'none';
                            });
                        });
                    });

                    // Add event listeners for med center checkboxes
                    document.querySelectorAll('.toggle-med-center').forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            const medCenter = this.dataset.medCenter;
                            const rows = document.querySelectorAll(`.med-center-row[data-med-center="${medCenter}"]`);
                            rows.forEach(row => {
                                row.style.display = this.checked ? '' : 'none';
                            });
                        });
                    });

                    // Trigger initial percentage conversion
                    const averageSliderPercentageCheckbox = document.querySelector('.average-slider-percentage');
                    if (averageSliderPercentageCheckbox && averageSliderPercentageCheckbox.checked) {
                        const event = new Event('change');
                        averageSliderPercentageCheckbox.dispatchEvent(event);
                    }
                });

                function updateExportCombinedForm() {
                    // Получаем все данные формы фильтрации
                    const formData = new FormData(document.getElementById('filter-form'));
                    const formParams = new URLSearchParams(formData);
                    
                    // Получаем информацию о видимых столбцах
                    const visibleColumns = [];
                    document.querySelectorAll('.toggle-column').forEach(checkbox => {
                        if (checkbox.checked) {
                            visibleColumns.push(checkbox.dataset.column);
                        }
                    });

                    // Получаем информацию о видимых медцентрах
                    const visibleMedCenters = [];
                    document.querySelectorAll('.toggle-med-center').forEach(checkbox => {
                        if (checkbox.checked) {
                            visibleMedCenters.push(checkbox.dataset.medCenter);
                        }
                    });

                    // Получаем информацию о процентах
                    const averageSliderPercentageCheckbox = document.querySelector('.average-slider-percentage');
                    const export_as_percentage = averageSliderPercentageCheckbox ? averageSliderPercentageCheckbox.checked : false;

                    // Получаем информацию о скрытии общего количества ответов
                    const hideTotalResponsesCheckbox = document.querySelector('.toggle-column[data-column="total-responses"]');
                    const hide_total_responses = hideTotalResponsesCheckbox ? !hideTotalResponsesCheckbox.checked : false;
                    
                    // Добавляем параметры в URL
                    formParams.set('visible_columns', visibleColumns.join(','));
                    formParams.set('visible_med_centers', visibleMedCenters.join(','));
                    formParams.set('export_as_percentage', export_as_percentage);
                    formParams.set('hide_total_responses', hide_total_responses);
                    
                    // Создаем URL для экспорта
                    const formCode = window.location.pathname.split('/')[2];
                    const exportUrl = `/form/${formCode}/responses/export_combined/?${formParams.toString()}`;
                    
                    // Перенаправляем на URL экспорта
                    window.location.href = exportUrl;
                }
            </script>
        </div>
        <div class="margin-top-bottom box question-box">
        <h2 class="response-title">Итоговые оценки медцентров</h2>
            <div class="responses-table-controls">
                <div class="table-zoom-controls">
                    <button type="button" class="table-zoom-btn zoom-out" data-table="totalScoresTable">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <span class="table-zoom-level" id="totalScoresTable-zoom">100%</span>
                    <button type="button" class="table-zoom-btn zoom-in" data-table="totalScoresTable">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            <div class="responses-table" id="totalScoresTable-container">
                <div class="table-scroll-indicator">Прокрутите для просмотра</div>
                <table id="totalScoresTable">
                    <thead>
                        <tr>
                            <th>Медицинский центр</th>
                            {% for form in active_forms %}
                                <th class="column-form-score">{{ form.title }}</th>
                            {% endfor %}
                            <th>Количество жалоб</th>
                            <th>Процент влияния жалоб</th>
                            <th class="column-final-score">Итоговая оценка</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
            <h2 class="response-title">Экспорт данных</h2>
            <form action="javascript:void(0);" method="GET">
                <button type="submit" class="btn send-form-btn big-screen" onclick="exportFinalScores()">Скачать Excel</button>
            </form>
            <script>
                function exportFinalScores() {
                    // Получаем все данные формы фильтрации
                    const formData = new FormData(document.getElementById('filter-form'));
                    const formParams = new URLSearchParams(formData);
                    
                    // Создаем URL для экспорта
                    const formCode = window.location.pathname.split('/')[2];
                    const exportUrl = `/form/${formCode}/responses/export_final_scores/?${formParams.toString()}`;
                    
                    // Перенаправляем на URL экспорта
                    window.location.href = exportUrl;
                }
            </script>
        </div>
        <div class="margin-top-bottom box question-box">
            <h1 class="response-title">Графики данных</h1>
            {% for r in responsesSummary %}
            {% if r.question.question_type == 'checkbox' or r.question.question_type == 'multiple choice' %}
            <div class="response-summary">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="response-summary-title">{{r.question.question}}</h3>
                    {% if r.answers|count > 0 %}
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button id="toggleChartBtn{{ r.question.id }}" class="toggle-chart-btn btn send-form-btn big-screen">Показать график</button>
                    </div>
                    {% endif %}
                </div>
                {% for choice in r.question.choices.all %}
                    <div class="choice">
                        <input type="radio" id="{{choice.id}}" disabled>
                        <label for="{{choice.id}}">
                            <input type="text" value="{{choice.choice}}" class="edit-choice" data-id="{{choice.id}}" disabled>
                        </label>
                    </div>
                {% endfor %}
                    
                {% if r.answers|count > 0 %}
                <!-- Store chart data in data attributes -->
                <div class="chart-container" id="chartContainer{{ r.question.id }}" style="display: none;">
                    <div class="loading-indicator">Загрузка данных...</div>
                    <div class="error-message" style="display: none; color: red; text-align: center; padding: 20px;"></div>
                    <select id="chartTypeSelect{{ r.question.id }}" class="chart-filter-select" data-id="{{r.question.id}}" data-origin_type="{{r.question.question_type}}">
                        <option value="bar" {% if question.question_type == 'bar' %}selected{% endif %}>Столбцы</option>
                        <option value="pie" {% if question.question_type == 'pie' %}selected{% endif %}>Круговая</option>
                        <!-- <option value="doughnut" {% if question.question_type == 'doughnut' %}selected{% endif %}>Кольцевая</option> -->
                        <option value="line" {% if question.question_type == 'line' %}selected{% endif %}>Линейная</option>
                        <option value="polarArea" {% if question.question_type == 'polarArea' %}selected{% endif %}>Полярная</option>
                    </select>
                    <canvas id="myChart{{r.question.id}}" class="chart"
                        data-chart-data='{
                            "labels": [{% for choice, count in filteredResponsesSummary|get_dict_items:r.question.id %}"{{choice}}"{% if not forloop.last %},{% endif %}{% endfor %}],
                            "datasets": [{
                                "label": "{{r.question.question}}",
                                "data": [{% for choice, count in filteredResponsesSummary|get_dict_items:r.question.id %}{{count}}{% if not forloop.last %},{% endif %}{% endfor %}],
                                "backgroundColor": [{% for choice, count in filteredResponsesSummary|get_dict_items:r.question.id %}"{{0|generate_color}}"{% if not forloop.last %},{% endif %}{% endfor %}],
                                "borderWidth": 1
                            }]
                        }'
                    ></canvas>
                </div>
                {% else %}
                <blockquote><i>Нет ответов</i></blockquote>
                {% endif %}
            </div>
            {% elif r.question.question_type == 'range slider' %}
            <div class="response-summary">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="response-summary-title">{{ r.question.question }}</h3>
                    {% with data=range_slider_data|get_item:r.question.id %}
                    {% if r.answers|count > 0 %}
                        <button id="toggleChartBtn{{ r.question.id }}" class="toggle-chart-btn btn send-form-btn big-screen">Показать график</button>
                    {% endif %}
                    {% endwith %}
                </div>
                <div class="answers" data-id="{{ question.id }}">
                    <input type="range" min="0" max="100" value="50" class="slider" disabled>
                    <label for="input-max-value">
                        <input type="number" id="input-max-value" value="{{ r.question.max_value }}" class="edit-choice" data-id="{{ r.question.id }}" placeholder="{{ r.question.max_value }}" disabled>
                    </label>
                </div>
                {% with data=range_slider_data|get_item:r.question.id %}
                {% if r.answers|count > 0 %}
                    <div class="chart-container" 
                         id="chartContainer{{ r.question.id }}" 
                         data-chart-type="range-slider"
                         data-analytics-type="range_slider"
                         style="display: none;"
                         data-url="{% url 'load_analytics_data' code=form.code %}?data_type=range_slider">
                        <div class="loading-indicator">Загрузка данных...</div>
                        <div class="error-message" style="display: none; color: red; text-align: center; padding: 20px;"></div>
                        <select class="input-question-type chart-filter-select" id="chartTypeSelect{{ r.question.id }}">
                            <option value="line">Линейный</option>
                            <option value="bar">Столбцы</option>
                        </select>
                        
                        <select class="time-period-select input-time-period chart-filter-select" id="timePeriodSelect{{ r.question.id }}">
                            <option value="12">12 месяцев</option>
                            <option value="6" selected>6 месяцев</option>
                            <option value="3">3 месяца</option>
                            <option value="2">2 месяца</option>
                            <option value="1">1 месяц</option>
                        </select>
            
                        <canvas id="combinedChart{{ r.question.id }}" width="600" height="400"></canvas>
                    </div>
                {% else %}
                    <blockquote><i>Нет ответов</i></blockquote>
                {% endif %}
                {% endwith %}
            </div>
        {% endif %}
    {% endfor %}
</div>
<div class="margin-top-bottom box question-box">
    <h2 class="response-title">Графики итоговых оценок медцентров</h2>
    <div class="chart-container" id="finalScoresChartContainer" data-chart-type="final-scores" data-url="{% url 'load_final_scores_chart' code=form.code %}">
        <div class="loading-indicator">Загрузка данных...</div>
        <div class="error-message" style="display: none; color: red; text-align: center; padding: 20px;"></div>
        <div class="chart-content" style="display: none;">
            <select class="question-type-select input-question-type" id="finalScoresChartType">
                <option value="bar">Столбцы</option>
                <option value="line">Линейный</option>
                <option value="radar">Радар</option>
                <option value="polarArea">Полярная область</option>
            </select>
            <canvas id="finalScoresChart" width="600" height="400"></canvas>
        </div>
    </div>
    
    <h2 class="response-title mt-4">График влияния жалоб на итоговую оценку</h2>
    <div class="chart-container" id="negativeImpactChartContainer" data-chart-type="negative-impact" data-url="{% url 'load_negative_impact_chart' code=form.code %}">
        <div class="loading-indicator">Загрузка данных...</div>
        <div class="error-message" style="display: none; color: red; text-align: center; padding: 20px;"></div>
        <div class="chart-content" style="display: none;">
            <canvas id="negativeImpactChart" width="600" height="400"></canvas>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const observerOptions = {
                root: null,
                rootMargin: '50px',
                threshold: 0.1
            };

            const chartInstances = new Map();

            const chartObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const chartContainer = entry.target;
                        const chartId = chartContainer.getAttribute('id');
                        
                        if (!chartInstances.has(chartId)) {
                            loadChartData(chartContainer);
                        }
                        
                        chartObserver.unobserve(chartContainer);
                    }
                });
            }, observerOptions);

            async function loadChartData(container) {
                const url = container.getAttribute('data-url');
                const loadingIndicator = container.querySelector('.loading-indicator');
                const errorMessage = container.querySelector('.error-message');
                const chartContent = container.querySelector('.chart-content');

                try {
                    loadingIndicator.style.display = 'block';
                    errorMessage.style.display = 'none';
                    chartContent.style.display = 'none';

                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(response.statusText || 'Ошибка загрузки данных');
                    }
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    loadingIndicator.style.display = 'none';
                    chartContent.style.display = 'block';
                    initializeChart(container, data);
                } catch (error) {
                    console.error('Error loading chart data:', error);
                    loadingIndicator.style.display = 'none';
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = error.message || 'Произошла ошибка при загрузке данных';
                }
            }

            function initializeFinalScoresChart(container, data) {
                const chartTypeSelect = document.getElementById('finalScoresChartType');
                const ctx = document.getElementById('finalScoresChart');
    
                if (!ctx || !chartTypeSelect) return;
    
                let finalScoresChart;
    
                const createChart = (type) => {
                    if (finalScoresChart) {
                        finalScoresChart.destroy();
                    }
    
                    finalScoresChart = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true,
                                        max: 100,
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }]
                            },
                            tooltips: {
                                callbacks: {
                                    label: function(tooltipItem, data) {
                                        return data.datasets[tooltipItem.datasetIndex].label + ': ' + tooltipItem.value + '%';
                                    }
                                }
                            }
                        }
                    });
                };
    
                createChart('bar');
    
                chartTypeSelect.addEventListener('change', function() {
                    createChart(this.value);
                });

                return finalScoresChart;
            }

            function initializeNegativeImpactChart(container, data) {
                const ctx = document.getElementById('negativeImpactChart');
                if (!ctx) return;

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [
                                {
                                    id: 'y-axis-1',
                                    type: 'linear',
                                    position: 'left',
                                    ticks: {
                                        beginAtZero: true,
                                        max: 100,
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    },
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Итоговая оценка'
                                    }
                                },
                                {
                                    id: 'y-axis-2',
                                    type: 'linear',
                                    position: 'right',
                                    ticks: {
                                        beginAtZero: true,
                                        stepSize: 1
                                    },
                                    scaleLabel: {
                                        display: true,
                                        labelString: 'Количество жалоб'
                                    }
                                }
                            ]
                        },
                        tooltips: {
                            callbacks: {
                                label: function(tooltipItem, data) {
                                    const dataset = data.datasets[tooltipItem.datasetIndex];
                                    const value = dataset.data[tooltipItem.index];
                                    if (dataset.label === 'Итоговая оценка') {
                                        return dataset.label + ': ' + value + '%';
                                    }
                                    return dataset.label + ': ' + value;
                                }
                            }
                        }
                    }
                });

                return chart;
            }

            function initializeChart(container, data) {
                const chartType = container.getAttribute('data-chart-type');
                let chart;

                switch (chartType) {
                    case 'final-scores':
                        chart = initializeFinalScoresChart(container, data);
                        break;
                    case 'negative-impact':
                        chart = initializeNegativeImpactChart(container, data);
                        break;
                }

                if (chart) {
                    chartInstances.set(container.id, chart);
                }
            }

            document.querySelectorAll('#finalScoresChartContainer, #negativeImpactChartContainer').forEach(container => {
                chartObserver.observe(container);
            });
        });
    </script>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize table zoom functionality
        initializeTableZoom();
        
        // Initialize scroll indicators
        initializeScrollIndicators();
    });
</script>
{% endblock %}