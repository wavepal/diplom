{% extends 'index/layout.html' %}
{% load static %}
{% load get_property %}
{% load generate_color %}
{% load count %}
{% load calculate_score %}
{% load calculate_penalty %}
{% load divide %}
{% block title %}{{form.title}} - Medical Forms{% endblock %}
{% block script %}
<script src="{% static 'index/responses_sc.js' %}" defer></script>
<script src="{% static 'lib/cookie.min.js' %}"></script>
{% endblock %}
{% block body %}
<div class="container-fluid">
    {% with active_tab='responses' %}
        {% include 'index/includes/sidebar.html' %}
    {% endwith %}
    <div class="container main-body">
        <span id="bg-color" style="display: none;">{{form.background_color}}</span>
        <span id="text-color" style="display: none;">{{form.text_color}}</span>
        <div class="margin-top-bottom box question-box table-settings" id="responses">
            {% if responses.count > 0 %}
            <h1 class="response-title">Список ответов:</h1>
            <input type="text" id="response-search" class="search-bar" placeholder="Поиск">
            <form id="response-form">
                {% csrf_token %}
                <ul class="modal-content" style="margin: 10px; padding: 0 25px; max-height: 40vh; overflow-y: auto; overflow-x: hidden;">
                    {% for i in responses %}
                        <p>
                            <input type="checkbox" name="response_ids" value="{{ i.id }}">
                            {% if form.collect_email %}
                                <a href="{% url 'response' form.code i.response_code %}" class="bl-link">
                                    Ответ {{ user.email }}
                                </a>
                                {% if form.is_quiz %}
                                    <span>{{ i|calculate_score:form }} / {{ form|calculate_total_score }}</span>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'response' form.code i.response_code %}" class="bl-link">
                                    {% if user.is_authenticated %}
                                    {% with profile_image=user.image_info.first %}
                                        {% if profile_image and profile_image.image %}
                                            <img id="profileImage" src="{{ profile_image.image.url }}" alt="Фото профиля" width="25" height="25" style="border-radius: 50%; vertical-align: middle;">
                                        {% else %}
                                            <img id="profileImage" src="{% static 'Icon\user.jpg' %}" alt="Фото профиля" width="25" height="25" style="border-radius: 50%; vertical-align: middle;">
                                        {% endif %}
                                    {% endwith %}
                                    {% endif %}
                                    {% if i.responder_username %}
                                        Ответ {{ i.responder_username }}
                                    {% else %}
                                        Ответ {{ i.response_code }}
                                    {% endif %}
                                    {% if form.is_quiz %}
                                        <span>- {{ i|calculate_score:form }} / {{ form|calculate_total_score }}</span>
                                    {% endif %}
                                </a>
                            {% endif %}
                        </p>
                    {% endfor %}
                </ul>
                {% if request.user.is_superuser %}
                <button type="button" class="btn btn-danger" id="delete-selected-responses">Удалить выделенные ответы</button>
                <button type="button" class="btn btn-danger" id="delete-responses">Очистить ответы</button>
                {% endif %}
            </form>
            {% else %}
            <h1 class="response-title">0 ответов</h1>
            {% endif %}
        </div>
        <div class="margin-top-bottom box question-box table-settings">
            <h1 class="response-title">Фильтрация данных</h1>
            <form id="filter-form" method="GET">
                <p>
                    <label for="cities">Регион пользователя:</label>
                    <select class="filter-select" id="cities" name="cities">
                        <option value="">Все регионы</option>
                        {% for city_code, city_name in city_choices %}
                            <option value="{{ city_code }}" {% if request.GET.cities == city_code %}selected{% endif %}>
                                {{ city_name }}
                            </option>
                        {% endfor %}
                    </select>
                </p>

                <p>
                    <label for="med_region">Регион медцентра:</label>
                    <select class="filter-select" id="med_region" name="med_region">
                        <option value="">Все регионы</option>
                        {% for city_code, city_name in city_choices %}
                            <option value="{{ city_code }}" {% if request.GET.med_region == city_code %}selected{% endif %}>
                                {{ city_name }}
                            </option>
                        {% endfor %}
                    </select>
                </p>

                <p>
                    <label for="med_group">Группа медцентров:</label>
                    <select class="filter-select" id="med_group" name="med_group">
                        <option value="">Все группы</option>
                        {% for group in med_center_groups %}
                            <option value="{{ group.id }}" {% if request.GET.med_group == group.id|stringformat:"s" %}selected{% endif %}>
                                {{ group.name }}
                            </option>
                        {% endfor %}
                    </select>
                </p>

                <p>
                    <label for="med_center">Медцентр:</label>
                    <select class="filter-select" id="med_center" name="med_center">
                        <option value="">Все медцентры</option>
                        {% for med_center in med_centers %}
                            <option value="{{ med_center }}" {% if request.GET.med_center == med_center %}selected{% endif %}>
                                {{ med_center }}
                            </option>
                        {% endfor %}
                    </select>
                </p>

                <p>
                    <label for="gender">Пол:</label>
                    <select class="filter-select" id="gender" name="gender">
                        <option value="">Все</option>
                        <option value="M" {% if request.GET.gender == 'M' %}selected{% endif %}>Мужской</option>
                        <option value="F" {% if request.GET.gender == 'F' %}selected{% endif %}>Женский</option>
                        <option value="O" {% if request.GET.gender == 'O' %}selected{% endif %}>Другой</option>
                    </select>
                </p>
                <p>
                    <label for="age_min">Возраст от:</label>
                    <input type="number" id="age_min" name="age_min" min="0" max="100" value="{{ request.GET.age_min }}">
                    <label for="age_max">до:</label>
                    <input type="number" id="age_max" name="age_max" min="0" max="100" value="{{ request.GET.age_max }}">
                </p>
                
                <!-- Добавляем сохранение выбранных значений для вопросов -->
                {% for question in form.questions.all %}
                    {% if question.question_type == "multiple choice" or question.question_type == "checkbox" %}
                        <p>
                            <label for="question-{{ question.id }}">Варианты ответа</label>
                            <select class="filter-choice-select" id="question-{{ question.id }}" name="question-{{ question.id }}" multiple>
                                <option value="">Все</option>
                                {% for choice in question.choices.all %}
                                    <option value="{{ choice.id }}" 
                                        {% if choice.id|stringformat:"s" in request.GET.getlist|add:"question-"|add:question.id|stringformat:"s" %}
                                            selected
                                        {% endif %}>
                                        {{ choice.choice }}
                                    </option>
                                {% endfor %}
                            </select>
                        </p>
                    {% endif %}
                {% endfor %}
                
                <!-- Добавляем фильтр по датам -->
                <p>
                    <label for="date_from">Период с:</label>
                    <input type="date" id="date_from" name="date_from" 
                           value="{{ request.GET.date_from }}" 
                           class="filter-date">
                    
                    <label for="date_to">по:</label>
                    <input type="date" id="date_to" name="date_to" 
                           value="{{ request.GET.date_to }}"
                           class="filter-date">
                </p>

                <div class="filter-buttons">
                    <button type="submit" class="btn send-form-btn">Применить фильтр</button>
                    <button type="button" id="reset-filters" class="btn btn-danger">Сбросить фильтры</button>
                </div>
            </form>
        </div>
        <script>
            document.getElementById('reset-filters').addEventListener('click', function() {
                // Сброс всех полей фильтрации
                document.getElementById('cities').value = '';
                document.getElementById('med_region').value = '';
                document.getElementById('med_group').value = '';
                document.getElementById('med_center').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('age_min').value = '';
                document.getElementById('age_max').value = '';
                
                // Добавляем сброс дат
                document.getElementById('date_from').value = '';
                document.getElementById('date_to').value = '';
                
                // Сброс выбранных вариантов ответов
                const questionSelects = document.querySelectorAll('select[name^="question-"]');
                questionSelects.forEach(select => {
                    select.value = '';
                });
                
                // Отправка формы для обновления результатов
                document.getElementById('filter-form').submit();
            });

            // Добавляем валидацию дат
            document.getElementById('date_to').addEventListener('change', function() {
                const dateFrom = document.getElementById('date_from').value;
                const dateTo = this.value;
                
                if (dateFrom && dateTo && dateFrom > dateTo) {
                    alert('Дата окончания периода не может быть раньше даты начала');
                    this.value = dateFrom;
                }
            });

            document.getElementById('date_from').addEventListener('change', function() {
                const dateFrom = this.value;
                const dateTo = document.getElementById('date_to').value;
                
                if (dateFrom && dateTo && dateFrom > dateTo) {
                    alert('Дата начала периода не может быть позже даты окончания');
                    this.value = dateTo;
                }
            });
        </script>
        <div class="margin-top-bottom box question-box">
            <h1 class="response-title">Таблица данных:</h1>
            <div class="responses-table">
                <table id="responsesTable">
                    <thead>
                        <tr>
                            <th class="column-user">Пользователь</th>
                            <th class="column-city">Город/Область</th>
                            <th class="column-age">Возраст</th>
                            <th class="column-gender">Пол</th>
                            <th class="column-med">Медцентр</th>
                            <th class="column-created-at">Дата проверки</th>
                            {% for summary in responsesSummary %}
                                {% if summary.question.question_type != "title" %}
                                    <th class="column-question-{{ summary.question.id }}">{{ summary.question.question }}
                                        <a class="column-question-score">
                                        {% if summary.question.score != 0 and form.is_quiz %}
                                            - {{ summary.question.score }} баллов
                                        {% endif %}
                                        </a>
                                    <br></th>
                                {% endif %}
                            {% endfor %}
                            {% if form.is_quiz %}
                                <th class="column-total-score">Набрано баллов</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for response in responses %}
                        <tr data-response-id="{{ response.id }}">
                            <td class="column-user">{% if response.responder_username %}{{ response.responder_username }}{% else %}Аноним{% endif %}</td>
                            <td class="column-city">
                                {% if response.responder_city %}
                                    {{ response.get_city_display }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="column-age">
                                {% if response.responder_age %}
                                    {{ response.responder_age }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="column-gender">
                                {% if response.responder_gender %}
                                    {{ response.get_gender_display }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="column-med">
                                {% if response.responder_med %}
                                    {{ response.responder_med }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="column-created-at">{{ response.createdAt|date:"d.m.Y H:i" }}</td>
                            {% for summary in responsesSummary %}
                                {% if summary.question.question_type != "title" %}
                                    <td class="column-question-{{ summary.question.id }} text-table" data-max-value="{{ summary.question.max_value }}">
                                        {% with answer=response_answers|get_item:response.id %}
                                            {% if summary.question.question_type == "paragraph" %}
                                                <p class="long-answer">{{ answer|get_item:summary.question.id|default:"N/A"|linebreaksbr }}</p>
                                            {% elif summary.question.question_type == "short" %}
                                                <p class="short-answer">{{ answer|get_item:summary.question.id|default:"N/A" }}</p>
                                            {% elif summary.question.question_type == "range slider" %}
                                                <a class="score-title range-slider-value" data-raw-value="{{ answer|get_item:summary.question.id }}">{{ answer|get_item:summary.question.id }}</a>
                                            {% elif summary.question.question_type == "multiple choice" %}
                                                {% with selected_choice=answer|get_item:summary.question.id %}
                                                    {% for choice in summary.question.choices.all %}
                                                        {% if selected_choice == choice.choice %}
                                                            <a class="score-title">{{ choice.choice }}
                                                                {% if form.is_quiz %}
                                                                    <span class="txtClr column-choice-score">({{ choice.scores }} баллов)</span>
                                                                {% endif %}
                                                            </a>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endwith %}
                                            {% elif summary.question.question_type == "checkbox" %}
                                                {% with selected_choices=answer|get_item:summary.question.id %}
                                                    {% if selected_choices != "N/A" %}
                                                        <ul>
                                                            {% for choice in summary.question.choices.all %}
                                                                {% if choice.choice in selected_choices %}
                                                                    <li>{{ choice.choice }}
                                                                        {% if form.is_quiz %}
                                                                            <span>({{ choice.scores }} баллов)</span>
                                                                        {% endif %}
                                                                    </li>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                {% endwith %}
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                {% endif %}
                            {% endfor %}
                            {% if form.is_quiz %}
                                <td class="column-total-score column-total-score-percentage">{{ response|calculate_score:form }} / {{ form|calculate_total_score }}</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <h2 class="response-title">Настройки таблицы:</h2>
            <form id="columnSelectorForm" class="table-settings">
                <fieldset class="table-field collapsed">
                    <legend>Данные пользователя</legend>
                    <div class="field-content">
                        <label><input type="checkbox" class="toggle-column" data-column="user" checked> Пользователь</label>
                        <label><input type="checkbox" class="toggle-column" data-column="city"> Город</label>
                        <label><input type="checkbox" class="toggle-column" data-column="age"> Возраст</label>
                        <label><input type="checkbox" class="toggle-column" data-column="gender"> Пол</label>
                        <label><input type="checkbox" class="toggle-column" data-column="created-at" checked> Дата проверки</label>
                        <label><input type="checkbox" class="toggle-column" data-column="med" checked> Медцентр</label>
                    </div>
                </fieldset>
                {% if form.is_quiz %}
                <fieldset class="table-field collapsed">
                    <legend>Баллы</legend>
                    <div class="field-content">
                        <label><input type="checkbox" class="toggle-column" data-column="choice-score" checked> Баллы по вариантам</label>
                        <label><input type="checkbox" class="toggle-column" data-column="question-score" checked> Баллы за правильный ответ</label>
                        <label><input type="checkbox" class="toggle-column" data-column="total-score" checked> Итоговый балл</label>
                        <label><input type="checkbox" class="total-score-percentage" checked> Процентное соотношение</label>
                    </div>
                </fieldset>
                {% endif %}
                <fieldset class="table-field collapsed">
                    <legend>Вопросы</legend>
                    <div class="field-content">
                        {% for summary in responsesSummary %}
                            {% if summary.question.question_type != "title" %}
                                <label><input type="checkbox" class="toggle-column" data-column="question-{{ summary.question.id }}" checked> {{ summary.question.question }}</label>
                            {% endif %}
                        {% endfor %}
                        <label><p><input type="checkbox" class="range-slider-percentage" checked> Процентное соотношение</p></label>
                    </div>
                </fieldset>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Добавляем класс collapsed ко всем секциям по умолчанию
                    const fields = document.querySelectorAll('.table-field');
                    fields.forEach(field => {
                        field.classList.add('collapsed');
                    });

                    // Обработчики для сворачивания разделов
                    const legends = document.querySelectorAll('.table-field legend');
                    legends.forEach(legend => {
                        legend.addEventListener('click', function() {
                            const fieldset = this.closest('.table-field');
                            fieldset.classList.toggle('collapsed');
                        });
                    });
                });
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const rangeSliderElements = document.querySelectorAll('.range-slider-value');

                    rangeSliderElements.forEach(function (element) {
                        const value = parseFloat(element.textContent.trim());
                        const maxRangeValue = element.closest('td').dataset.maxValue; // Fetching max value from data attribute
                        element.dataset.rawValue = value; // Storing the original value
                        if (!isNaN(value) && value !== null) {
                            const percentage = (value / maxRangeValue) * 100;
                            element.textContent = percentage.toFixed(2) + '%';
                            element.style.color = getColorBasedOnPercentage(percentage);
                        } else {
                            element.textContent = 'N/A';
                            element.style.color = '';
                        }
                    });
                });

                document.querySelector('.range-slider-percentage').addEventListener('change', function () {
                    const isPercentage = this.checked;
                    const rangeSliderElements = document.querySelectorAll('.range-slider-value');

                    rangeSliderElements.forEach(function (element) {
                        let value = parseFloat(element.dataset.rawValue);
                        const maxRangeValue = element.closest('td').dataset.maxValue; // Fetching max value from data attribute
                        if (!isNaN(value) && value !== null) {
                            if (isPercentage) {
                                const percentage = (value / maxRangeValue) * 100;
                                element.textContent = percentage.toFixed(2) + '%';
                                element.style.color = getColorBasedOnPercentage(percentage);
                            } else {
                                element.textContent = value;
                                element.style.color = '';
                            }
                        } else {
                            element.textContent = 'N/A';
                            element.style.color = '';
                        }
                    });
                });
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const totalScoreElements = document.querySelectorAll('.column-total-score-percentage');
                    const maxScore = {{ form|calculate_total_score }};

                    totalScoreElements.forEach(function (element) {
                        const scoreText = element.textContent.split('/')[0].trim();
                        const score = parseFloat(scoreText);
                        element.dataset.rawScore = score; // Save initial value
                        if (!isNaN(score) && score !== null) {
                            const percentage = (score / maxScore) * 100;
                            element.textContent = percentage.toFixed(2) + '%';
                            element.style.color = getColorBasedOnPercentage(percentage);
                        } else {
                            element.textContent = 'N/A';
                            element.style.color = '';
                        }
                    });

                    document.querySelector('.total-score-percentage').addEventListener('change', function () {
                        const isPercentage = this.checked;
                        totalScoreElements.forEach(function (element) {
                            let score = parseFloat(element.dataset.rawScore);
                            if (!isNaN(score) && score !== null) {
                                if (isPercentage) {
                                    const percentage = (score / maxScore) * 100;
                                    element.textContent = percentage.toFixed(2) + '%';
                                    element.style.color = getColorBasedOnPercentage(percentage);
                                } else {
                                    element.textContent = score + ' / ' + maxScore;
                                    element.style.color = '';
                                }
                            } else {
                                element.textContent = 'N/A';
                                element.style.color = '';
                            }
                        });
                    });
                });

                function getColorBasedOnPercentage(percentage) {
                    if (isNaN(percentage)) {
                        return '';
                    } else if (percentage >= 80) {
                        return '#00b300'; // Зеленый
                    } else if (percentage >= 50) {
                        return '#ffcc00'; // Желтый
                    } else {
                        return '#ff3300'; // Красный
                    }
                }
            </script>
            <h1 class="response-title">Экспорт данных</h1>
            <script>
                function updateExportForm() {
                    const cities = document.getElementById('cities').value;
                    const gender = document.getElementById('gender').value;
                    const age_min = document.getElementById('age_min').value;
                    const age_max = document.getElementById('age_max').value;
            
                    let hidden_columns = [];
                    document.querySelectorAll('.toggle-column').forEach(checkbox => {
                        if (!checkbox.checked) {
                            hidden_columns.push(checkbox.dataset.column);
                        }
                    });
            
                    const rangeSliderPercentageCheckbox = document.querySelector('.range-slider-percentage');
                    const totalScorePercentageCheckbox = document.querySelector('.total-score-percentage');
            
                    const export_as_percentage = rangeSliderPercentageCheckbox ? rangeSliderPercentageCheckbox.checked : false;
                    const export_total_as_percentage = totalScorePercentageCheckbox ? totalScorePercentageCheckbox.checked : false;
            
                    document.getElementById('export-cities').value = cities;
                    document.getElementById('export-gender').value = gender;
                    document.getElementById('export-age-min').value = age_min;
                    document.getElementById('export-age-max').value = age_max;
                    document.getElementById('export-hidden-columns').value = hidden_columns.join(',');
                    document.getElementById('export-as-percentage').value = export_as_percentage;
                    document.getElementById('export-total-as-percentage').value = export_total_as_percentage;
                    document.getElementById('export-form').submit();
                }
            </script>          
            <form id="export-form" action="{% url 'export_responses_to_excel' code=form.code %}" method="GET">
                <input type="hidden" id="export-cities" name="cities">
                <input type="hidden" id="export-gender" name="gender">
                <input type="hidden" id="export-age-min" name="age_min">
                <input type="hidden" id="export-age-max" name="age_max">
                <input type="hidden" id="export-hidden-columns" name="hidden_columns">
                <input type="hidden" id="export-as-percentage" name="export_as_percentage">
                <input type="hidden" id="export-total-as-percentage" name="export_total_as_percentage">
                <button type="button" class="btn send-form-btn big-screen" onclick="updateExportForm()">Скачать Excel</button>
            </form>
        </div>
        <div class="margin-top-bottom box question-box">
            <h2 class="response-title">Средние оценки и количество ответов по медцентрам</h2>
            <div class="responses-table">
                <table id="medCenterTable">
                    <thead>
                        <tr>
                            <th>Медицинский центр</th>
                            {% for question in form.questions.all %}
                                {% if question.question_type == "range slider" %}
                                    <th class="question-header column-{{ question.id }}">{{ question.question }} <span class="column-max-value">(макс. {{ question.max_value }})</span></th>
                                {% endif %}
                            {% endfor %}
                            {% for question in form.questions.all %}
                                {% if question.is_negative %}
                                    <th class="column-answ-{{ question.id }}">{{ question.question }}</th>
                                {% endif %}
                            {% endfor %}
                            <th class="column-main-value">Общая оценка</th>
                            <th class="column-total-responses">Общее количество ответов</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med_center, scores in average_scores_sorted %}
                        <tr class="med-center-row" data-med-center="{{ med_center }}">
                            <td>{{ med_center }}</td>
                            {% for question in form.questions.all %}
                                {% if question.question_type == "range slider" %}
                                    <td class="column-{{ question.id }}" data-max-value="{{ question.max_value }}">
                                        <span class="score-title average-slider-value" data-raw-value="{{ scores.scores|get_item:question.id|default:"N/A" }}">
                                            {% with value=scores.scores|get_item:question.id %}
                                                {% if value is None or value == '' %}
                                                    N/A
                                                {% elif value == 0 %}
                                                    0
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            {% endwith %}                                        
                                        </span>
                                    </td>
                                {% endif %}
                            {% endfor %}
                            {% with stats=med_center_stats|get_item:med_center %}
                                {% for question in form.questions.all %}
                                    {% if question.is_negative %}
                                        <td class="column-answ-{{ question.id }}">
                                            {{ stats.questions|get_dict_item:question.id|default:0 }}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                                <td class="total-score">
                                    {% with total_score=scores.total_score %}
                                        {% if total_score == None %}
                                            <a class="score-title" style="color: black;">N/A</a>
                                        {% elif total_score >= 80 %}
                                            <a class="score-title" style="color: #00b300;">{{ total_score }}</a>
                                        {% elif total_score >= 50 %}
                                            <a class="score-title" style="color: #ffcc00;">{{ total_score }}</a>
                                        {% else %}
                                            <a class="score-title" style="color: #ff3300;">{{ total_score }}</a>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="score-title column-total-responses">{{ stats.total_responses }}</td>
                            {% endwith %}
                        </tr>
                        {% endfor %}
                    </tbody>                
                </table>
            </div>
            <h2 class="response-title">Настройки таблицы:</h2>
            <form id="columnSelectorForm" class="table-settings">
                <fieldset class="table-field collapsed">
                    <legend>Значения</legend>
                    <div class="field-content">
                        <label><input type="checkbox" class="toggle-column" data-column="max-value" checked> Максимальные значения</label>
                        <label><input type="checkbox" class="toggle-column" data-column="main-value" checked> Общая оценка</label>
                        <label><input type="checkbox" class="toggle-column" data-column="total-responses" checked> Общее количество ответов</label>
                    </div>
                </fieldset>
                <fieldset class="table-field collapsed">
                    <legend>Медцентры</legend>
                    <div class="field-content">
                        {% for med_center in med_centers %}
                            <label>
                                <input type="checkbox" class="toggle-med-center" data-med-center="{{ med_center }}" checked> {{ med_center }}
                            </label>
                        {% endfor %}
                    </div>
                </fieldset>
                <fieldset class="table-field collapsed">
                    <legend>Критерии</legend>
                    <div class="field-content">
                        {% for question in form.questions.all %}
                            {% if question.question_type == "range slider" %}
                                <label>
                                    <input type="checkbox" class="toggle-column" data-column="{{ question.id }}" checked> {{ question.question }}
                                </label>
                            {% endif %}
                        {% endfor %}
                        <label><p><input type="checkbox" class="average-slider-percentage" checked> Процентное соотношение</p></label>
                    </div>
                </fieldset>
                <fieldset class="table-field collapsed">
                    <legend>Вопросы</legend>
                    <div class="field-content">
                        {% for question in form.questions.all %}
                            {% if question.is_negative %}
                                <label>
                                    <input type="checkbox" class="toggle-column" data-column="answ-{{ question.id }}" checked> {{ question.question }}
                                </label>
                            {% endif %}
                        {% endfor %}
                    </div>
                </fieldset>
            </form>
            <h2 class="response-title">Экспорт данных</h2>
            <form id="export-combined-form" action="{% url 'export_combined_excel' code=form.code %}" method="GET">
                <input type="hidden" name="visible_columns" id="combined_visible_columns">
                <input type="hidden" name="visible_med_centers" id="combined_visible_med_centers">
                <input type="hidden" name="export_as_percentage" id="export-combined-as-percentage">
                <input type="hidden" name="hide_total_responses" id="hide-total-responses">
                <button type="submit" class="btn send-form-btn big-screen" onclick="updateExportCombinedForm()">Скачать Excel</button>
            </form>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Apply initial column visibility based on checkboxes
                    document.querySelectorAll('.toggle-column').forEach(function(checkbox) {
                        const column = checkbox.dataset.column;
                        const cells = document.querySelectorAll(`.column-${column}`);
                        cells.forEach(cell => {
                            cell.style.display = checkbox.checked ? '' : 'none';
                        });
                    });

                    // Add event listeners for checkbox changes
                    document.querySelectorAll('.toggle-column').forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            const column = this.dataset.column;
                            const cells = document.querySelectorAll(`.column-${column}`);
                            cells.forEach(cell => {
                                cell.style.display = this.checked ? '' : 'none';
                            });
                        });
                    });

                    // Add event listeners for med center checkboxes
                    document.querySelectorAll('.toggle-med-center').forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            const medCenter = this.dataset.medCenter;
                            const rows = document.querySelectorAll(`.med-center-row[data-med-center="${medCenter}"]`);
                            rows.forEach(row => {
                                row.style.display = this.checked ? '' : 'none';
                            });
                        });
                    });
                });

                function updateExportCombinedForm() {
                    const visibleColumns = [];
                    document.querySelectorAll('.toggle-column').forEach(checkbox => {
                        if (checkbox.checked) {
                            visibleColumns.push(checkbox.dataset.column);
                        }
                    });
                    document.getElementById('combined_visible_columns').value = visibleColumns.join(',');

                    const visibleMedCenters = [];
                    document.querySelectorAll('.toggle-med-center').forEach(checkbox => {
                        if (checkbox.checked) {
                            visibleMedCenters.push(checkbox.dataset.medCenter);
                        }
                    });
                    document.getElementById('combined_visible_med_centers').value = visibleMedCenters.join(',');

                    const averageSliderPercentageCheckbox = document.querySelector('.average-slider-percentage');
                    const export_as_percentage = averageSliderPercentageCheckbox ? averageSliderPercentageCheckbox.checked : false;
                    document.getElementById('export-combined-as-percentage').value = export_as_percentage;

                    const hideTotalResponsesCheckbox = document.querySelector('.toggle-column[data-column="total-responses"]');
                    const hide_total_responses = hideTotalResponsesCheckbox ? !hideTotalResponsesCheckbox.checked : false;
                    document.getElementById('hide-total-responses').value = hide_total_responses;
                }

                document.querySelectorAll('.toggle-column, .toggle-med-center').forEach(checkbox => {
                    checkbox.addEventListener('change', updateExportCombinedForm);
                });

                // Обновить форму экспорта при загрузке страницы
                updateExportCombinedForm();
            </script>
            <script>
                document.querySelector('.average-slider-percentage').addEventListener('change', function () {
                    const isPercentage = this.checked;
                    const averageSliderElements = document.querySelectorAll('.average-slider-value');

                    averageSliderElements.forEach(function (element) {
                        let value = parseFloat(element.dataset.rawValue);
                        if (element.dataset.rawValue === 'N/A') {
                            element.textContent = 'N/A';
                            element.style.color = '';
                            return;
                        }
                        const maxRangeValue = element.closest('td').dataset.maxValue; // Fetching max value from data attribute
                        if (isPercentage) {
                            const percentage = (value / maxRangeValue) * 100;
                            element.textContent = percentage.toFixed(2) + '%';
                            element.style.color = getColorBasedOnPercentage(percentage);
                        } else {
                            element.textContent = value;
                            element.style.color = '';
                        }
                    });
                });

                function getColorBasedOnPercentage(percentage) {
                    if (percentage >= 80) {
                        return '#00a000'; // Темно-зеленый
                    } else if (percentage >= 50) {
                        return '#ffd700'; // Золотисто-желтый
                    } else {
                        return '#ff4500'; // Красно-оранжевый
                    }
                }

                // Инициализация значений при загрузке страницы
                document.addEventListener('DOMContentLoaded', function () {
                    const averageSliderElements = document.querySelectorAll('.average-slider-value');
                    averageSliderElements.forEach(function (element) {
                        const value = parseFloat(element.textContent.trim());
                        if (isNaN(value)) {
                            element.textContent = 'N/A';
                            element.style.color = '';
                            return;
                        }
                        const maxRangeValue = element.closest('td').dataset.maxValue; // Fetching max value from data attribute
                        element.dataset.rawValue = value; // Storing the original value
                        const percentage = (value / maxRangeValue) * 100;
                        element.textContent = percentage.toFixed(2) + '%';
                        element.style.color = getColorBasedOnPercentage(percentage);
                    });
                });
            </script>
        </div>
        <div class="margin-top-bottom box question-box">
        <h2 class="response-title">Итоговые оценки медцентров</h2>
            <div class="responses-table">
                <table id="totalScoresTable">
                    <thead>
                        <tr>
                            <th>Медицинский центр</th>
                            {% for form in active_forms %}
                                <th class="column-form-score">{{ form.title }}</th>
                            {% endfor %}
                            <th>Количество жалоб</th>
                            <th>Процент влияния жалоб</th>
                            <th class="column-final-score">Итоговая оценка</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for med_center, data in final_scores.items %}
                        <tr>
                            <td>{{ med_center }}</td>
                            {% for form in active_forms %}
                                <td class="form-score">
                                    {% with score=data.forms|get_item:form.title %}
                                        {% if score >= 80 %}
                                            <span class="score-title" style="color: #00b300;">{{ score|floatformat:2 }}</span>
                                        {% elif score >= 50 %}
                                            <span class="score-title" style="color: #ffcc00;">{{ score|floatformat:2 }}</span>
                                        {% elif score > 0 %}
                                            <span class="score-title" style="color: #ff3300;">{{ score|floatformat:2 }}</span>
                                        {% else %}
                                            <span class="score-title" style="color: black;">N/A</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                            {% endfor %}
                            <td><span class="score-title">{{ data.negative_count }}</span></td>
                            <td>
                                <span class="score-title" 
                                      style="{% if data.negative_count == 0 %}color: #00b300;{% elif data.negative_count == 1 %}color: #80b300;{% elif data.negative_count == 2 %}color: #ffcc00;{% elif data.negative_count == 3 %}color: #ff9933;{% elif data.negative_count == 4 %}color: #ff3300;{% else %}color: #000000;{% endif %}">
                                    {{ data.negative_percentage }}%
                                </span>
                            </td>
                            <td class="final-score">
                                {% with final_score=data.total_score %}
                                    {% if final_score >= 80 %}
                                        <span class="score-title" style="color: #00b300;">{{ final_score|floatformat:2 }}</span>
                                    {% elif final_score >= 50 %}
                                        <span class="score-title" style="color: #ffcc00;">{{ final_score|floatformat:2 }}</span>
                                    {% elif final_score > 0 %}
                                        <span class="score-title" style="color: #ff3300;">{{ final_score|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="score-title" style="color: black;">N/A</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <h2 class="response-title">Экспорт данных</h2>
            <form action="{% url 'export_final_scores' form.code %}" method="GET">
                <button type="submit" class="btn send-form-btn big-screen">Скачать Excel</button>
            </form>
        </div>
        <div class="margin-top-bottom box question-box">
            <h1 class="response-title">Графики данных</h1>
            {% for r in responsesSummary %}
                {% if r.question.question_type == 'checkbox' or r.question.question_type == 'multiple choice' %}
                    <div class="response-summary">
                        <h3 class="response-summary-title">{{r.question.question}}</h3>
                        {% if r.answers|count > 0 or filteredResponsesSummary|get_property:r.question.question|count > 0 %}
                        <select class="question-type-select input-question-type" data-id="{{r.question.id}}" data-origin_type="{{r.question.question_type}}">
                            <option value="bar" {% if question.question_type == 'bar' %}selected{% endif %}>Столбцы</option>
                            <option value="pie" {% if question.question_type == 'pie' %}selected{% endif %}>Пирог</option>
                            <option value="doughnut" {% if question.question_type == 'doughnut' %}selected{% endif %}>Пончик</option>
                            <option value="line" {% if question.question_type == 'line' %}selected{% endif %}>Линейная</option>
                            <option value="polarArea" {% if question.question_type == 'polarArea' %}selected{% endif %}>Полярная</option>
                        </select>
                            <canvas id="myChart{{r.question.id}}" width="600" height="300"></canvas>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
                        <script>
                            var ctx{{r.question.id}} = document.getElementById("myChart{{r.question.id}}").getContext("2d");
                            var chartData{{r.question.id}} = {
                                labels: [{% for i in filteredResponsesSummary|get_property:r.question.id %}"{{i}}",{% endfor %}],
                                datasets: [{
                                    label: '{{ r.question.question }}',
                                    data: [{% for i in filteredResponsesSummary|get_property:r.question.id %}{{filteredResponsesSummary|get_property:r.question.id|get_property:i}},{% endfor %}],
                                    backgroundColor: [{% for _ in filteredResponsesSummary|get_property:r.question.id %}"{{0|generate_color}}",{% endfor %}],
                                    borderWidth: 1
                                }]
                            };
                            var chart{{r.question.id}} = new Chart(ctx{{r.question.id}}, {
                                type: 'bar',
                                data: chartData{{r.question.id}},
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        yAxes: [{
                                            ticks: {
                                                beginAtZero: true,
                                                stepSize: 1
                                            }
                                        }],
                                        xAxes: [{
                                            ticks: {
                                                autoSkip: false
                                            }
                                        }]
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                }
                            });
                            document.querySelector('.question-type-select[data-id="{{r.question.id}}"]').addEventListener('change', function () {
                                var selectedOption = this.value;
                                chart{{r.question.id}}.destroy();
                                chart{{r.question.id}} = new Chart(ctx{{r.question.id}}, {
                                    type: selectedOption,
                                    data: chartData{{r.question.id}},
                                    options: {
                                        responsive: true, 
                                        maintainAspectRatio: false,
                                    }
                                });
                            });
                        </script>
                        {% else %}
                        <blockquote><i>Нет ответов</i></blockquote>
                        {% endif %}
                    </div>
                    {% elif r.question.question_type == 'range slider' %}
                    <div class="response-summary">
                        <h3 class="response-summary-title">{{ r.question.question }}</h3>
                    
                        {% with data=range_slider_data|get_item:r.question.id %}
                        {% if r.answers|count > 0 or filteredResponsesSummary|get_property:r.question.question|count > 0 %}
                            <button id="toggleChartBtn{{ r.question.id }}" class="toggle-chart-btn btn send-form-btn big-screen">Показать график</button>
                    
                            <div id="chartContainer{{ r.question.id }}" class="chart-container" style="display: none;">
                                <select class="input-question-type chart-filter-select" id="chartTypeSelect{{ r.question.id }}">
                                    <option value="line">Линейный</option>
                                    <option value="bar">Столбцы</option>
                                </select>
                                <select class="time-period-select input-time-period chart-filter-select" id="timePeriodSelect{{ r.question.id }}">
                                    <option value="12">12 месяцев</option>
                                    <option value="6" selected>6 месяцев</option>
                                    <option value="3">3 месяца</option>
                                    <option value="2">2 месяца</option>
                                    <option value="1" style="display: none;">1 месяц</option>
                                </select>
                    
                                <canvas id="combinedChart{{ r.question.id }}" width="600" height="300"></canvas>
                            </div>
                    
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    const toggleChartBtn = document.getElementById("toggleChartBtn{{ r.question.id }}");
                                    const chartContainer = document.getElementById("chartContainer{{ r.question.id }}");
                                    const chartTypeSelect = document.getElementById("chartTypeSelect{{ r.question.id }}");
                                    const timePeriodSelect = document.getElementById("timePeriodSelect{{ r.question.id }}");
                                    let chart = null;

                                    toggleChartBtn.addEventListener('click', function () {
                                        if (chartContainer.style.display === "none") {
                                            chartContainer.style.display = "block";
                                            toggleChartBtn.textContent = "Скрыть график";

                                            if (!chart) {
                                                const ctx = document.getElementById("combinedChart{{ r.question.id }}").getContext("2d");

                                                const maxValue = {{ data.max_value }};
                                                const roundValue = value => Math.round(value);

                                                const lineChartData = {
                                                    labels: [{% for month in data.months %}"{{ month }}"{% if not forloop.last %},{% endif %}{% endfor %}],
                                                    datasets: [
                                                        {% for center, averages in data.averages_by_center.items %}
                                                        {
                                                            label: '{{ center }}',
                                                            data: [{% for avg in averages %}
                                                                {% if avg %}
                                                                    {{ avg|stringformat:".2f"|multiply:100|divide:data.max_value }}
                                                                {% else %}
                                                                    0
                                                                {% endif %}
                                                                {% if not forloop.last %},{% endif %}
                                                            {% endfor %}],
                                                            borderColor: '{{ forloop.counter0|generate_color }}',
                                                            backgroundColor: 'rgba(0, 0, 0, 0)',
                                                            borderWidth: 2,
                                                            fill: false
                                                        }{% if not forloop.last %},{% endif %}
                                                        {% endfor %}
                                                    ]
                                                };

                                                const barChartData = {
                                                    labels: [{% for month in data.months %}"{{ month }}"{% if not forloop.last %},{% endif %}{% endfor %}],
                                                    datasets: [
                                                        {% for center, averages in data.averages_by_center.items %}
                                                        {
                                                            label: '{{ center }}',
                                                            data: [{% for avg in averages %}
                                                                {% if avg %}
                                                                    {{ avg|stringformat:".2f"|multiply:100|divide:data.max_value }}
                                                                {% else %}
                                                                    0
                                                                {% endif %}
                                                                {% if not forloop.last %},{% endif %}
                                                            {% endfor %}],
                                                            backgroundColor: '{{ forloop.counter0|generate_color }}',
                                                            borderWidth: 1
                                                        }{% if not forloop.last %},{% endif %}
                                                        {% endfor %}
                                                    ]
                                                };

                                                const updateChart = (timePeriod) => {
                                                    const filteredLabels = lineChartData.labels.slice(-timePeriod);
                                                    const filteredLineDatasets = lineChartData.datasets.map(dataset => ({
                                                        ...dataset,
                                                        data: dataset.data.slice(-timePeriod)
                                                    }));
                                                    const filteredBarDatasets = barChartData.datasets.map(dataset => ({
                                                        ...dataset,
                                                        data: dataset.data.slice(-timePeriod)
                                                    }));

                                                    if (chart) {
                                                        chart.destroy();
                                                    }
                                                    
                                                    chart = new Chart(ctx, {
                                                        type: chartTypeSelect.value,
                                                        data: {
                                                            labels: filteredLabels,
                                                            datasets: chartTypeSelect.value === 'line' ? filteredLineDatasets : filteredBarDatasets
                                                        },
                                                        options: {
                                                            responsive: true,
                                                            maintainAspectRatio: false,
                                                            scales: {
                                                                yAxes: [{
                                                                    ticks: {
                                                                        beginAtZero: true,
                                                                        max: 100,
                                                                        callback: function(value) {
                                                                            return value.toFixed(1) + '%';
                                                                        }
                                                                    }
                                                                }],
                                                                xAxes: [{
                                                                    ticks: {
                                                                        autoSkip: false
                                                                    }
                                                                }]
                                                            },
                                                            legend: {
                                                                display: true,
                                                                position: 'top'
                                                            },
                                                            tooltips: {
                                                                callbacks: {
                                                                    label: function(tooltipItem, data) {
                                                                        return data.datasets[tooltipItem.datasetIndex].label + ': ' + tooltipItem.yLabel.toFixed(1) + '%';
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    });
                                                };

                                                const initialTimePeriod = parseInt(timePeriodSelect.value);
                                                updateChart(initialTimePeriod);

                                                timePeriodSelect.addEventListener('change', function () {
                                                    const selectedTimePeriod = parseInt(timePeriodSelect.value);
                                                    updateChart(selectedTimePeriod);
                                                });

                                                chartTypeSelect.addEventListener('change', function () {
                                                    const selectedChartType = chartTypeSelect.value;
                                                    const oneMonthOption = timePeriodSelect.querySelector('option[value="1"]');
                                                    if (selectedChartType === 'bar') {
                                                        oneMonthOption.style.display = 'block';
                                                    } else {
                                                        oneMonthOption.style.display = 'none';
                                                        if (timePeriodSelect.value === '1') {
                                                            timePeriodSelect.value = '2';
                                                        }
                                                    }
                                                    updateChart(parseInt(timePeriodSelect.value));
                                                });
                                            }
                                        } else {
                                            chartContainer.style.display = "none";
                                            toggleChartBtn.textContent = "Показать график";
                                        }
                                    });
                                });
                            </script>
                        {% else %}
                            <blockquote><i>Нет ответов</i></blockquote>
                        {% endif %}
                        {% endwith %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="margin-top-bottom box question-box">
            <h2 class="response-title">Графики итоговых оценок медцентров</h2>
            <div class="chart-container">
                <select class="question-type-select input-question-type" id="finalScoresChartType">
                    <option value="bar">Столбцы</option>
                    <option value="line">Линейный</option>
                    <option value="radar">Радар</option>
                    <option value="polarArea">Полярная область</option>
                </select>
                <canvas id="finalScoresChart" width="600" height="400"></canvas>
            </div>
            <!-- Добавляем загрузку Chart.js перед скриптами -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
            <script>
                // Ждем полной загрузки DOM и Chart.js
                window.addEventListener('load', function() {
                    const chartTypeSelect = document.getElementById('finalScoresChartType');
                    const ctx = document.getElementById('finalScoresChart');
    
                    if (!ctx || !chartTypeSelect) {
                        console.error('Required elements not found');
                        return;
                    }
    
                    let finalScoresChart;
    
                    const chartData = {
                        labels: [{% for med_center, data in final_scores.items %}"{{ med_center }}",{% endfor %}],
                        datasets: [
                            {% for form in active_forms %}
                            {
                                label: "{{ form.title }}",
                                data: [
                                    {% for med_center, data in final_scores.items %}
                                        {{ data.forms|get_item:form.title|default:0 }},
                                    {% endfor %}
                                ],
                                backgroundColor: "{{ forloop.counter0|generate_color }}",
                                borderColor: "{{ forloop.counter0|generate_color }}",
                                borderWidth: 2,
                                fill: false
                            }{% if not forloop.last %},{% endif %}
                            {% endfor %}
                        ]
                    };
    
                    const createChart = (type) => {
                        if (finalScoresChart) {
                            finalScoresChart.destroy();
                        }
    
                        finalScoresChart = new Chart(ctx.getContext('2d'), {
                            type: type,
                            data: chartData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    yAxes: [{
                                        ticks: {
                                            beginAtZero: true,
                                            max: 100,
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        }
                                    }]
                                },
                                tooltips: {
                                    callbacks: {
                                        label: function(tooltipItem, data) {
                                            return data.datasets[tooltipItem.datasetIndex].label + ': ' + tooltipItem.value + '%';
                                        }
                                    }
                                }
                            }
                        });
                    };
    
                    // Создаем начальный график
                    createChart('bar');
    
                    // Обработчик изменения типа графика
                    chartTypeSelect.addEventListener('change', function() {
                        createChart(this.value);
                    });
                });
            </script>
    
            <h2 class="response-title mt-4">График влияния жалоб на итоговую оценку</h2>
            <div class="chart-container">
                <canvas id="negativeImpactChart" width="600" height="400"></canvas>
            </div>
            <script>
                // Ждем полной загрузки DOM и Chart.js
                window.addEventListener('load', function() {
                    const ctx = document.getElementById('negativeImpactChart');
    
                    if (!ctx) {
                        console.error('Negative impact chart canvas not found');
                        return;
                    }
    
                    const data = {
                        labels: [{% for med_center, data in final_scores.items %}"{{ med_center }}",{% endfor %}],
                        datasets: [
                            {
                                label: 'Итоговая оценка',
                                data: [{% for med_center, data in final_scores.items %}{{ data.total_score }},{% endfor %}],
                                backgroundColor: '#4CAF50',
                                borderColor: '#4CAF50',
                                borderWidth: 2,
                                yAxisID: 'y-axis-1',
                                order: 2
                            },
                            {
                                label: 'Количество жалоб',
                                data: [{% for med_center, data in final_scores.items %}{{ data.negative_count }},{% endfor %}],
                                backgroundColor: '#FF3030',
                                borderColor: '#FF3030',
                                borderWidth: 2,
                                type: 'line',
                                yAxisID: 'y-axis-2',
                                order: 1
                            }
                        ]
                    };
    
                    new Chart(ctx.getContext('2d'), {
                        type: 'bar',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                yAxes: [
                                    {
                                        id: 'y-axis-1',
                                        type: 'linear',
                                        position: 'left',
                                        ticks: {
                                            beginAtZero: true,
                                            max: 100,
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: 'Итоговая оценка'
                                        }
                                    },
                                    {
                                        id: 'y-axis-2',
                                        type: 'linear',
                                        position: 'right',
                                        ticks: {
                                            beginAtZero: true,
                                            stepSize: 1
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: 'Количество жалоб'
                                        }
                                    }
                                ]
                            },
                            tooltips: {
                                callbacks: {
                                    label: function(tooltipItem, data) {
                                        const dataset = data.datasets[tooltipItem.datasetIndex];
                                        const value = dataset.data[tooltipItem.index];
                                        if (dataset.label === 'Итоговая оценка') {
                                            return dataset.label + ': ' + value + '%';
                                        }
                                        return dataset.label + ': ' + value;
                                    }
                                }
                            }
                        }
                    });
                });
            </script>
        </div>
    </div>
    <div class="modal" id="customize-theme">
        <div class="modal-content">
            <span class="modal-close-btn" id="close-customize-theme">&times;</span>
            <h1 class="modal-title">Настройки цвета</h1>
            <h3 class="modal-subtitle">Цвет фона:  <input type="color"  value = "{{form.background_color}}" list="bgColors" class="form-control-color" id="input-bg-color" /></h3>
            <datalist id="bgColors">
                <option value="#aed581"></option>
                <option value="#80deea"></option>
                <option value="#b2ebf2"></option>
                <option value="#e1bee7"></option>
                <option value="#d1c4e9"></option>
                <option value="#f0f4c3"></option>
                <option value="#f5f5f5"></option>
                <option value="#cfd8dc"></option>
                <option value="#e6ee9c"></option>
                <option value="#202124"></option>
            </datalist>
            <h3 class="modal-subtitle">Цвет текста:  <input type="color"  value = {{form.text_color}} list="textColors" class="form-control-color" id="input-text-color" /></h3>
            <datalist id="textColors">
                <option value="#880000"></option>
                <option value="#512da8"></option>
                <option value="#1a237e"></option>
                <option value="#005cbf"></option>
                <option value="#0288d1"></option>
                <option value="#00695c"></option>
                <option value="#424242"></option>
                <option value="#321932"></option>
                <option value="#121212"></option>
            </datalist>
        </div>
    </div>
    <div class="modal" id="setting">
        <div class="modal-content txt-clr">
            <form id="setting-form">
                <span class="modal-close-btn" id="close-setting">&times;</span>
                <h1 class = "modal-title">Настройки</h1>
                <h4 class="setting-preview-form small-screen"><a href="{% url 'view_form' form.code %}">Превью формы</a></h4>
                <div class="modal-division">
                    <div class="form-group">
                        <h3 class="modal-subtitle">Общее</h3>
                        <input type="checkbox" id="collect_email"{% if form.collect_email %} checked {% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="collect_email" class="setting-form-label">Сбор E-mail адресов.</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="is_quiz" {% if form.is_quiz %} checked {% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="is_quiz" class="setting-form-label">Преобразовать в тест</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="authenticated_responder" {% if form.authenticated_responder %} checked {% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="authenticated_responder" class="setting-form-label">Только авторизованные пользователи.</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="limit_ip" {% if form.limit_ip %}checked{% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="limit_ip" class="setting-form-label">Возможность ответить только один раз анонимным пользователям.</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="submit_limit" {% if form.submit_limit %}checked{% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="submit_limit" class="setting-form-label">Возможность ответить только один раз авторизованным пользователям.</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="is_single_form" {% if form.is_single_form %}checked{% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="is_single_form" class="setting-form-label">Доступ в телеграм-боте</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="is_active" {% if form.is_active %}checked{% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="is_active" class="setting-form-label">Учитывать в общей оценке</label>
                    </div>
                    <script>
                        document.getElementById('limit_ip').addEventListener('change', function() {
                            const limitIpValue = this.checked;
                        
                            fetch("{% url 'edit_setting' form.code %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}',
                                },
                                body: JSON.stringify({ limit_ip: limitIpValue })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message === "Success") {
                                    console.log("Setting updated successfully");
                                } else {
                                    console.log("Failed to update setting");
                                }
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                        });
                    </script>
                    <script>
                        document.getElementById('submit_limit').addEventListener('change', function() {
                            const submitLimitValue = this.checked;
                        
                            fetch("{% url 'edit_setting' form.code %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}',
                                },
                                body: JSON.stringify({ submit_limit: submitLimitValue })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message === "Success") {
                                    console.log("Setting updated successfully");
                                } else {
                                    console.log("Failed to update setting");
                                }
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                        });
                    </script>
                    <script>
                        document.getElementById('is_single_form').addEventListener('change', function() {
                            const isSingleFormValue = this.checked;
                        
                            fetch("{% url 'edit_setting' form.code %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}',
                                },
                                body: JSON.stringify({ is_single_form: isSingleFormValue })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.message === "Success") {
                                    console.log("Setting updated successfully");
                                } else {
                                    console.log("Failed to update setting");
                                }
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
                        });
                    </script>
                </div>
                <div class="modal-division">
                    <div class="form-group">
                        <h3 class="modal-subtitle">Опрошенные могут:</h3>
                        <input type="checkbox" id="edit_after_submit" {% if form.edit_after_submit %}checked{% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="edit_after_submit" class="setting-form-label">Вносить изменения после отправки</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="allow_view_score" {% if form.allow_view_score %}checked{% endif %} {% if not request.user.is_superuser %}disabled{% endif %}>
                        <label for="allow_view_score" class="setting-form-label">Просмотреть свои оценки</label>
                    </div>
                </div>
                <div class="modal-division">
                    <div class="form-group">
                        <h3 class="modal-subtitle">Сообщение после отправки:</h3>
                        <textarea rows="1" class="confirmation-msg-input edit-on-click textarea-adjust" spellcheck="false"
                         id="comfirmation_message" {% if not request.user.is_superuser %}disabled{% endif %}>{{form.confirmation_message}}</textarea>
                    </div>
                </div>
                <div class="form-group">
                  <input type="submit" value="Сохранить" class="form-control btn btn-save-setting">
                </div>
            </form>
            <form id="delete-form" class="modal-division">
                    <input type="submit" value="Удалить" class="form-control btn delete-form-btn">
            </form>
        </div>
    </div>
    <div class="modal" id="send-form">
        <div class="modal-content">
            <span class="modal-close-btn" id="close-send-form">&times;</span>
            <h1 class="modal-title">Поделиться формой</h1>
            <div class="modal-division">
                <h4 class="modal-subtitle">Ссылка:</h4>
                <input type="url" class="form-control" id="copy-url" value="http://{{request.get_host}}/form/{{form.code}}/viewform">
            </div>
            <button class="btn btn-submit" copy-btn>Копировать</button>
            <div class="modal-division">
                <h4 class="modal-subtitle">Код:</h4>
                <input type="text" class="form-control" id="copy-code-url" value="{{form.code}}">
            </div>
            <button class="btn btn-submit" copy-code-btn>Копировать</button>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const searchInput = document.getElementById('response-search');
        const responseList = document.querySelector('.modal-content');

        searchInput.addEventListener('input', function() {
            const searchTerm = searchInput.value.toLowerCase();

            Array.from(responseList.children).forEach(function(responseItem) {
                const responseText = responseItem.textContent.toLowerCase();
                if (responseText.includes(searchTerm)) {
                    responseItem.style.display = 'block';
                } else {
                    responseItem.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}